<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的單字卡 (PWA 完善版)</title>
    
    <!-- PWA Modifications START -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#4CAF50">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#333333">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <!-- PWA Modifications END -->

    <style>
        :root {
            /* Default Theme (Green) */
            --primary-color: #4CAF50;
            --primary-color-darker: #388E3C;
            --accent-color: #03a9f4; /* For deck buttons and other accents */
            --accent-color-darker: #0288d1; /* Darker version of accent */
            --background-color: #f4f7f6;
            --card-background: #fff;
            --text-color: #333;
            --text-color-light: #fff;
            --text-color-muted: #6c7a89;
            --border-color: #ccc;
            --border-color-light: #ddd;
            --accent-red: #f44336;
            --accent-red-darker: #d32f2f;
            --accent-orange: #ff9800;
            --accent-yellow: #ffc107;
            --bg-image: none;
            --bg-blur: 0px;
            --container-opacity-percent: 95%; /* Container opacity */
        }

        html, body {
            height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; justify-content: center; align-items: center; 
            color: var(--text-color);
            background-color: var(--background-color);
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-color 0.3s ease, background-image 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            text-align: center; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 500px; width: 100%; height: 100vh; max-height: 800px; box-sizing: border-box; padding: 20px;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
            backdrop-filter: blur(var(--bg-blur));
            -webkit-backdrop-filter: blur(var(--bg-blur));
            background-color: color-mix(in srgb, var(--card-background) var(--container-opacity-percent), transparent);
            transition: background-color 0.3s ease;
        }
        h1 { color: var(--primary-color); margin-top: 0; margin-bottom: 20px; font-size: 2.5em; flex-shrink: 0; }
        .view {
            display: none; width: 100%; flex-grow: 1; overflow-y: auto; box-sizing: border-box;
            padding-bottom: 20px; flex-direction: column; align-items: center; position: relative;
        }
        .view.active { display: flex; }

        .main-menu-container {
            border: 2px solid var(--border-color); border-radius: 10px; padding: 20px; background-color: color-mix(in srgb, var(--background-color) 50%, transparent);
            width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; align-items: stretch; margin-bottom: 20px;
        }
        
        .import-section, .settings-section {
            padding: 15px; border: 2px dashed var(--accent-color); border-radius: 10px;
            background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); display: flex; flex-direction: column; gap: 10px; align-items: stretch;
        }
        .settings-section { margin-top: 15px; }
        .import-section label, .settings-section label { font-weight: bold; color: var(--accent-color-darker); }
        .import-section input[type="file"], .settings-section input[type="file"] { border: 1px solid var(--border-color); padding: 8px; border-radius: 5px; background-color: white; }
        .import-section button, .settings-section button { background-color: var(--accent-color); color: var(--text-color-light); }
        .category-item {
            padding: 15px 20px; font-size: 1.2em; border: none; border-radius: 8px; cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); font-weight: bold; color: var(--text-color-light);
            background-color: var(--accent-color);
            text-align: left; display: flex; flex-direction: row;
            justify-content: space-between; align-items: center;
        }
        .category-item:hover { transform: translateY(-2px); background-color: var(--accent-color-darker); }
        .category-item.unfamiliar-category { background-color: var(--accent-red); }
        .category-item.unfamiliar-category:hover { background-color: var(--accent-red-darker); }
        .category-item.default-category { background-color: #78909c; }
        .category-item.default-category:hover { background-color: #546e7a; }
        .unfamiliar-count, .manage-deck-btn {
            background-color: rgba(255, 255, 255, 0.3); border-radius: 5px;
            padding: 5px 10px; font-size: 0.9em; margin-left: 10px;
        }
        .manage-deck-btn { cursor: pointer; transition: background-color 0.2s; font-size: 1.1em; }
        .manage-deck-btn:hover { background-color: rgba(0, 0, 0, 0.2); }
        
        /* --- Selection View Styles --- */
        #mode-selection-view {
            justify-content: flex-start; gap: 15px; padding-top: 20px;
        }
        .selection-title {
            color: var(--primary-color-darker); font-size: 1.8em; margin-bottom: 0;
        }
        .selection-subtitle {
            font-size: 1.2em; color: var(--text-color-muted); margin-top: 5px; margin-bottom: 20px; font-weight: bold;
        }
        .selection-buttons-container {
            display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 350px;
        }
        .selection-buttons-container .category-item {
            text-align: center; justify-content: center;
        }
        #open-word-selection-btn { background-color: var(--accent-orange); margin-bottom: 15px; justify-content: center; text-align: center; }

        /* --- Flashcard View Styles --- */
        .flashcard-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; width: 100%; padding-top: 10px; box-sizing: border-box; }
        .flashcard { background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); border: 2px solid color-mix(in srgb, var(--primary-color) 40%, transparent); border-radius: 10px; width: min(80vw, 350px); height: min(80vw, 350px); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; box-sizing: border-box; overflow: hidden; text-align: center; flex-shrink: 0; position: relative; }
        .flashcard.revealed-background { background-color: color-mix(in srgb, var(--accent-yellow) 20%, transparent); }
        .flashcard.reading-mode-card .translation { display: block !important; } /* Reading Mode always shows translation */
        .word { font-size: 2.2em; font-weight: bold; color: var(--text-color); margin-bottom: 15px; word-wrap: break-word; padding: 0 10px; }
        .translation { font-size: 1.5em; color: var(--text-color-muted); font-weight: 500; word-wrap: break-word; display: none; padding: 0 10px; }
        .progress { font-size: 1em; color: #555; margin-top: 10px; }
        .progress span { font-weight: bold; color: var(--primary-color); }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 300px; flex-shrink: 0; }
        button { padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); font-weight: bold; }
        button:disabled { background-color: #bdbdbd; cursor: not-allowed; opacity: 0.7; }
        button:disabled:hover { background-color: #bdbdbd; }
        #mark-unfamiliar-btn { background-color: var(--accent-orange); color: var(--text-color-light); }
        #mark-unfamiliar-btn.unmark-mode { background-color: var(--accent-yellow); }
        #mark-unfamiliar-btn.delete-mode { background-color: var(--accent-red); }
        
        /* --- Quiz & Spelling View Styles --- */
        .quiz-view-common { justify-content: flex-start; gap: 20px; padding-top: 15px; }
        .quiz-progress-bar-container { width: 90%; height: 8px; background-color: var(--border-color-light); border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .quiz-progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); transition: width 0.3s ease; }
        .quiz-question-area { display: flex; flex-direction: column; align-items: center; width: 100%; gap: 20px;}
        .quiz-question-display { font-size: 2em; font-weight: bold; padding: 20px; min-height: 80px; }
        .quiz-options-container { display: grid; grid-template-columns: 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .quiz-option { font-size: 1.1em; padding: 15px; background-color: var(--accent-color); color: var(--text-color-light); }
        .quiz-option:hover:not(:disabled) { background-color: var(--accent-color-darker); }
        .quiz-option.correct { background-color: var(--primary-color) !important; }
        .quiz-option.incorrect { background-color: var(--accent-red) !important; }
        .quiz-results-container { display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; flex-grow: 1; }
        .quiz-results-container h2 { color: var(--primary-color-darker); }
        .quiz-score-display { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
        .back-to-mode-selection-btn { background-color: var(--accent-color); color: var(--text-color-light); margin-top: 20px; }
        .quiz-nav-controls { display: flex; justify-content: space-between; width: 100%; max-width: 400px; margin-top: 20px; }
        #add-incorrect-to-unfamiliar-btn { background-color: var(--accent-orange); color: var(--text-color-light); margin-top: 15px; }

        /* Spelling Quiz Specifics */
        #spelling-input-form { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 350px; }
        #spelling-input {
            padding: 15px; font-size: 1.2em; text-align: center; border: 2px solid var(--border-color);
            border-radius: 8px; transition: border-color 0.3s;
        }
        #spelling-input:focus { border-color: var(--primary-color); outline: none; }
        #spelling-feedback { min-height: 2em; font-size: 1.1em; font-weight: bold; }
        .feedback-correct { color: var(--primary-color-darker); }
        .feedback-incorrect { color: var(--accent-red-darker); }

        .top-button { position: absolute; top: 20px; z-index: 20; background-color: rgba(0, 0, 0, 0.3); color: var(--text-color-light); padding: 8px; font-size: 1.8em; border-radius: 5px; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); line-height: 1; cursor: pointer; border: none; flex-shrink: 0; }
        #back-to-menu-btn { left: 20px; }
        #fullscreen-btn { right: 20px; }
        #bookmark-icon { position: absolute; top: 10px; right: 10px; font-size: 1.5em; color: #e0b445; display: none; z-index: 5; }
        #speak-btn { position: absolute; bottom: 10px; right: 10px; font-size: 1.8em; color: var(--accent-color); cursor: pointer; z-index: 5; border: none; background: none; padding: 5px; transition: color 0.2s, transform 0.2s; display: none; }
        #speak-btn:hover { color: var(--accent-color-darker); transform: scale(1.1); }
        
        /* Other view styles... */
        #deck-management-view { gap: 15px; justify-content: flex-start; align-items: stretch; } #deck-manager-title { color: var(--accent-color-darker); margin: 0 0 10px 0; flex-shrink: 0; text-align: center; } .deck-manager-actions { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 2px solid var(--border-color-light); background-color: #f5f5f5; flex-shrink: 0; } .deck-manager-actions label { display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer; } .deck-manager-actions input[type="checkbox"] { transform: scale(1.4); cursor: pointer; } #multi-delete-btn { background-color: var(--accent-red); color: var(--text-color-light); padding: 8px 15px; font-size: 1em; } #multi-delete-btn:hover:not(:disabled) { background-color: var(--accent-red-darker); } .word-list-container { width: 100%; flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color-light); border-radius: 8px; padding: 10px; background-color: color-mix(in srgb, var(--card-background) 50%, transparent); padding-bottom: 80px; box-sizing: border-box; } .word-list-item { display: flex; justify-content: flex-start; align-items: center; padding: 12px 10px; border-bottom: 1px solid var(--border-color-light); font-size: 1.1em; gap: 15px; cursor: pointer; transition: background-color 0.2s; } .word-list-item:hover { background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); } .word-list-item:last-child { border-bottom: none; } .word-list-item .word-select-checkbox { transform: scale(1.5); flex-shrink: 0; cursor: pointer; } .word-content-wrapper { flex-grow: 1; text-align: left; } .deck-actions-container { margin-top: auto; display: flex; flex-direction: column; gap: 10px; } #export-deck-btn { background-color: var(--accent-color); color: var(--text-color-light); } #export-deck-btn:hover { background-color: var(--accent-color-darker); } #delete-deck-btn { background-color: var(--accent-red-darker); color: var(--text-color-light); } #delete-deck-btn:hover:not(:disabled) { background-color: #b71c1c; } #delete-deck-btn:disabled { background-color: #bdbdbd; cursor: not-allowed; opacity: 0.7; } .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; } .modal-overlay.active { opacity: 1; visibility: visible; } .modal-content { background-color: var(--card-background); padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 100%; max-width: 400px; transform: translateY(-20px); transition: transform 0.3s ease, background-color 0.3s ease; position: relative; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column;} .modal-overlay.active .modal-content { transform: translateY(0); } .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 2em; font-weight: bold; color: #888; cursor: pointer; border: none; background: none; padding: 0; line-height: 1; } .modal-close-btn:hover { color: #333; } .modal-content h3 { margin-top: 0; color: var(--primary-color); } .modal-form { display: flex; flex-direction: column; gap: 15px; } .modal-form input { padding: 12px; font-size: 1.1em; border-radius: 8px; border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; } .modal-form button { background-color: var(--primary-color); color: var(--text-color-light); } .add-word-feedback { color: var(--primary-color); font-weight: bold; height: 1.5em; margin-top: -10px; margin-bottom: 10px; transition: opacity 0.5s; opacity: 0; } .add-word-feedback.show { opacity: 1; } #confirm-modal-title { color: var(--accent-red-darker); } .confirm-modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; } #confirm-modal-cancel-btn { background-color: #9e9e9e; color: var(--text-color-light); } #confirm-modal-confirm-btn { background-color: var(--accent-red-darker); color: var(--text-color-light); } #open-add-word-modal-btn { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: color-mix(in srgb, var(--primary-color) 70%, transparent); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-color-light); border-radius: 50%; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); cursor: pointer; z-index: 10; transition: all 0.2s ease-in-out; display: flex; justify-content: center; align-items: center; font-size: 2.8em; font-weight: 200; } #open-add-word-modal-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); background-color: color-mix(in srgb, var(--primary-color) 90%, transparent); } #open-add-word-modal-btn:active { transform: translateY(0px) scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); } #settings-modal h4 { margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color-light); padding-bottom: 5px; color: var(--primary-color-darker); } .themes-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; } .theme-swatch { padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; text-align: center; position: relative; } .theme-swatch:hover { transform: translateY(-2px); } .theme-swatch.active { border-color: var(--primary-color); box-shadow: 0 0 10px color-mix(in srgb, var(--primary-color) 50%, transparent); } .swatch-color { width: 100%; height: 30px; border-radius: 5px; margin-bottom: 5px; border: 1px solid rgba(0,0,0,0.1); } .swatch-label { font-weight: bold; font-size: 0.9em; } .delete-theme-btn { position: absolute; top: -5px; right: -5px; background-color: var(--accent-red); color: white; border: 1px solid white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; line-height: 18px; text-align: center; cursor: pointer; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); } .theme-swatch:hover .delete-theme-btn { display: block; } .custom-theme-container { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; } .color-picker-group, .slider-group { display: flex; align-items: center; justify-content: space-between; } .color-picker-group label, .slider-group label { font-weight: 500; } .color-picker-group input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 50px; height: 30px; border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; background-color: transparent; padding: 0; } .color-picker-group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; } .color-picker-group input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; } .slider-group input[type="range"] { flex-grow: 1; margin: 0 10px; } .slider-group span { font-weight: bold; min-width: 40px; text-align: right; } #remove-bg-image-btn, #save-custom-theme-btn { background-color: var(--accent-orange); color: var(--text-color-light); font-size: 0.9em; padding: 8px 12px; } .settings-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; } #settings-save-btn { background-color: var(--primary-color); color: var(--text-color-light); }
        /* Word Selection Modal Styles */
        #word-selection-list-container { flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color-light); border-radius: 8px; padding: 10px; margin-top: 15px; margin-bottom: 15px;}
        .word-selection-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid var(--border-color-light); font-size: 1.1em; cursor: pointer; }
        .word-selection-item:last-child { border-bottom: none; }
        .word-selection-item input[type="checkbox"] { transform: scale(1.4); cursor: pointer; }
        .word-selection-controls { display: flex; gap: 10px; justify-content: flex-start; margin-bottom: 10px; flex-shrink: 0; }
        .word-selection-actions { margin-top: auto; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>單字卡</h1>
        
        <button id="back-to-menu-btn" class="top-button" title="返回上一步">&#x2B05;</button>
        <button id="fullscreen-btn" class="top-button" title="切換全螢幕">&#x21F3;</button>

        <div id="main-menu-view" class="view">
            <div id="main-menu-container" class="main-menu-container"></div>
            <div class="import-section">
                <label for="file-importer">或從檔案匯入單字包 (可多選 .json):</label>
                <input type="file" id="file-importer" accept=".json" multiple>
                <button id="import-btn">匯入並新增</button> 
            </div>
            <div class="settings-section">
                <button id="open-settings-btn">主題與設定 🎨</button>
            </div>
        </div>

        <div id="mode-selection-view" class="view">
            <h2 class="selection-title">選擇學習模式</h2>
            <p id="selected-deck-name-display" class="selection-subtitle"></p>
            <div class="selection-buttons-container">
                <button id="open-word-selection-btn" class="category-item">⚙️ 篩選單字 (預設全選)</button>
                <button id="start-reading-mode-btn" class="category-item">📖 閱讀模式 (快速瀏覽)</button>
                <button id="start-basic-mode-btn" class="category-item">▶️ 基礎模式 (依序學習)</button>
                <button id="start-shuffle-mode-btn" class="category-item">🔀 洗牌模式 (隨機順序)</button>
                <button id="start-spelling-quiz-btn" class="category-item">⌨️ 拼寫測驗 (打字)</button>
                <button id="start-mc-quiz-btn" class="category-item">✍️ 選擇測驗 (四選一)</button>
            </div>
        </div>
        
        <div id="language-direction-view" class="view">
            <h2 class="selection-title">選擇顯示語言</h2>
            <p id="selected-deck-and-mode-display" class="selection-subtitle"></p>
            <div class="selection-buttons-container">
                <button id="start-en-first-btn" class="category-item">先顯示 英文</button>
                <button id="start-zh-first-btn" class="category-item">先顯示 中文</button>
            </div>
        </div>

        <div id="flashcard-view" class="view">
             <div class="flashcard-content">
                <div id="mode-display">學習模式</div>
                <div id="flashcard" class="flashcard">
                    <span id="bookmark-icon">&#x1F516;</span>
                    <button id="speak-btn" title="發音">&#x1F50A;</button> 
                    <div id="word-display" class="word"></div>
                    <div id="translation-display" class="translation"></div>
                </div>
                <div class="controls">
                    <button id="mark-unfamiliar-btn">標記為不熟</button>
                </div>
                <p class="instructions" style="font-size:0.9em;color:#888;margin-top:15px;">點擊卡片**左半邊**返回上一張，點擊**右半邊**顯示翻譯或前往下一張。</p>
                <p class="progress">進度：<span id="current-count">0</span> / <span id="total-count">0</span></p>
            </div>
        </div>
        
        <div id="mc-quiz-view" class="view quiz-view-common">
            <div class="quiz-progress-bar-container"><div id="mc-quiz-progress-bar" class="quiz-progress-bar"></div></div>
            <div class="quiz-question-area" id="mc-quiz-question-area">
                <div class="quiz-question-display" id="mc-quiz-question-display">Question Here</div>
                <div class="quiz-options-container" id="mc-quiz-options-container">
                    <button class="quiz-option" data-option-index="0"></button>
                    <button class="quiz-option" data-option-index="1"></button>
                    <button class="quiz-option" data-option-index="2"></button>
                    <button class="quiz-option" data-option-index="3"></button>
                </div>
                <div class="quiz-nav-controls">
                    <button id="mc-quiz-prev-btn">上一題</button>
                    <button id="mc-quiz-next-btn">下一題</button>
                    <button id="finish-mc-quiz-btn" style="display:none;">完成測驗</button>
                </div>
            </div>
            <div class="quiz-results-container" id="mc-quiz-results-container">
                <h2>選擇測驗完成！</h2>
                <p class="quiz-score-display" id="mc-quiz-score-display">3 / 10</p>
                <div id="mc-quiz-add-unfamiliar-container"></div>
                <button class="back-to-mode-selection-btn">返回模式選擇</button>
            </div>
        </div>

        <div id="spelling-quiz-view" class="view quiz-view-common">
            <div class="quiz-progress-bar-container"><div id="spelling-quiz-progress-bar" class="quiz-progress-bar"></div></div>
            <div class="quiz-question-area" id="spelling-quiz-question-area">
                <div class="quiz-question-display" id="spelling-quiz-question-display">中文題目</div>
                <form id="spelling-input-form">
                    <input type="text" id="spelling-input" placeholder="請輸入英文" 
                           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" required>
                    <div id="spelling-feedback"></div>
                    <button type="submit" id="spelling-submit-btn">確認</button>
                </form>
                <div class="quiz-nav-controls">
                    <button id="spelling-quiz-prev-btn">上一題</button>
                    <button id="spelling-quiz-next-btn">下一題</button>
                    <button id="finish-spelling-quiz-btn" style="display:none;">完成測驗</button>
                </div>
            </div>
             <div class="quiz-results-container" id="spelling-quiz-results-container">
                <h2>拼寫測驗完成！</h2>
                <p class="quiz-score-display" id="spelling-quiz-score-display">8 / 10</p>
                <div id="spelling-quiz-add-unfamiliar-container"></div>
                <button class="back-to-mode-selection-btn">返回模式選擇</button>
            </div>
        </div>

        <div id="deck-management-view" class="view">
            <h2 id="deck-manager-title">管理單字包</h2>
            <div class="deck-manager-actions">
                <label> <input type="checkbox" id="select-all-words-checkbox"> <span>全選</span> </label>
                <button id="multi-delete-btn" disabled>刪除已選 (0)</button>
            </div>
            <div class="word-list-container" id="word-list-container"></div>
            <div class="deck-actions-container">
                <button id="export-deck-btn">匯出此單字卡包</button>
                <button id="delete-deck-btn">刪除此單字卡包</button>
            </div>
            <button id="open-add-word-modal-btn" title="新增單字">+</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-word-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close-btn" title="關閉">&times;</button><h3>新增單字</h3><form class="modal-form" id="add-word-form"><input type="text" id="new-word-english" placeholder="新英文單字" required><input type="text" id="new-word-chinese" placeholder="新中文翻譯" required><div class="add-word-feedback"></div><button type="submit">新增單字</button></form></div></div>
    <div id="edit-word-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close-btn" title="關閉">&times;</button><h3>編輯單字</h3><form class="modal-form" id="edit-word-form"><input type="text" id="edit-word-english" placeholder="英文單字" required><input type="text" id="edit-word-chinese" placeholder="中文翻譯" required><button type="submit">儲存變更</button></form></div></div>
    <div id="confirm-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close-btn" title="關閉">&times;</button><h3 id="confirm-modal-title">請確認</h3><p id="confirm-modal-text" style="margin: 20px 0; font-size: 1.1em; word-wrap: break-word;"></p><div class="confirm-modal-actions"><button id="confirm-modal-cancel-btn">取消</button><button id="confirm-modal-confirm-btn">確認</button></div></div></div>
    <div id="settings-modal" class="modal-overlay"><div class="modal-content"><button class="modal-close-btn" title="關閉">&times;</button><h3>主題設定</h3><h4>預設主題</h4><div class="themes-container" id="preset-themes-container"></div><h4 id="user-themes-heading" style="display:none;">我的主題</h4><div class="themes-container" id="user-themes-container"></div><h4>自訂主題</h4><div class="custom-theme-container"><div class="color-picker-group"><label for="primary-color-picker">主要顏色</label><input type="color" id="primary-color-picker"></div><div class="color-picker-group"><label for="accent-color-picker">點綴顏色</label><input type="color" id="accent-color-picker"></div><div class="color-picker-group"><label for="background-color-picker">背景顏色</label><input type="color" id="background-color-picker"></div><div class="slider-group"><label for="container-opacity-slider">背景不透明度</label><input type="range" id="container-opacity-slider" min="10" max="100" step="1"><span id="opacity-display">100%</span></div><div class="color-picker-group"><label for="background-image-uploader">上傳背景圖片</label><input type="file" id="background-image-uploader" accept="image/*" style="max-width: 150px;"></div><button id="remove-bg-image-btn">移除背景圖片</button><button id="save-custom-theme-btn">儲存目前主題</button></div><div class="settings-actions"><button id="settings-save-btn">套用並儲存</button></div></div></div>
    <div id="word-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" title="關閉">&times;</button>
            <h3>篩選學習單字</h3>
            <div class="word-selection-controls">
                <button id="word-select-all-btn">全選</button>
                <button id="word-select-none-btn">全不選</button>
            </div>
            <div id="word-selection-list-container"></div>
            <div class="word-selection-actions">
                 <button id="confirm-word-selection-btn">確認選擇</button>
            </div>
        </div>
    </div>


    <script>
        // --- State Variables ---
        const DEFAULT_DECK_NAME = "自訂單字卡";
        let allWordCategoriesData = {}; let unfamiliarWordsInNormalCycle = []; let currentManagingDeck = null;
        let currentWordsSource = [], shuffledWords = [], currentIndex = 0;
        let currentMode = 'normal', currentCategoryName = '';
        let feedbackTimeout; let currentStudyMode = 'en-first'; let confirmAction = null; let selectedWordsToDelete = new Set();
        let pendingLearningMode = {}; let isReadingMode = false;
        let selectedWordsForSession = new Set();
        let mcQuizQuestions = [], currentMcQuizIndex = 0, mcQuizUserAnswers = [], incorrectMcQuizWords = new Set();
        let spellingQuizQuestions = [], currentSpellingQuizIndex = 0, spellingQuizUserAnswers = [], incorrectSpellingQuizWords = new Set();
        
        // --- DOM Elements ---
        const views = { 'main-menu-view': document.getElementById('main-menu-view'), 'flashcard-view': document.getElementById('flashcard-view'), 'deck-management-view': document.getElementById('deck-management-view'), 'mode-selection-view': document.getElementById('mode-selection-view'), 'language-direction-view': document.getElementById('language-direction-view'), 'mc-quiz-view': document.getElementById('mc-quiz-view'), 'spelling-quiz-view': document.getElementById('spelling-quiz-view'),};
        const backToMenuBtnTop = document.getElementById('back-to-menu-btn');
        const mainMenuContainer = document.getElementById('main-menu-container');
        const fullscreenBtn = document.getElementById('fullscreen-btn'); const importBtn = document.getElementById('import-btn'); const fileImporter = document.getElementById('file-importer'); const deckManagerTitle = document.getElementById('deck-manager-title'); const wordListContainer = document.getElementById('word-list-container'); const deleteDeckBtn = document.getElementById('delete-deck-btn'); const flashcard = document.getElementById('flashcard'), wordDisplay = document.getElementById('word-display'), translationDisplay = document.getElementById('translation-display'), currentCountSpan = document.getElementById('current-count'), totalCountSpan = document.getElementById('total-count'), markUnfamiliarBtn = document.getElementById('mark-unfamiliar-btn'), modeDisplay = document.getElementById('mode-display'), bookmarkIcon = document.getElementById('bookmark-icon'); const openAddWordModalBtn = document.getElementById('open-add-word-modal-btn'); const exportDeckBtn = document.getElementById('export-deck-btn'); const selectAllCheckbox = document.getElementById('select-all-words-checkbox'); const multiDeleteBtn = document.getElementById('multi-delete-btn'); const speakBtn = document.getElementById('speak-btn'); const selectedDeckNameDisplay = document.getElementById('selected-deck-name-display'); const startBasicModeBtn = document.getElementById('start-basic-mode-btn'); const startShuffleModeBtn = document.getElementById('start-shuffle-mode-btn'); const startReadingModeBtn = document.getElementById('start-reading-mode-btn'); const startMcQuizBtn = document.getElementById('start-mc-quiz-btn'); const startSpellingQuizBtn = document.getElementById('start-spelling-quiz-btn'); const selectedDeckAndModeDisplay = document.getElementById('selected-deck-and-mode-display'); const startEnFirstBtn = document.getElementById('start-en-first-btn'); const startZhFirstBtn = document.getElementById('start-zh-first-btn');
        const openWordSelectionBtn = document.getElementById('open-word-selection-btn');
        const mcQuizProgressBar = document.getElementById('mc-quiz-progress-bar'); const mcQuizQuestionArea = document.getElementById('mc-quiz-question-area'); const mcQuizQuestionDisplay = document.getElementById('mc-quiz-question-display'); const mcQuizOptionsContainer = document.getElementById('mc-quiz-options-container'); const mcQuizOptionButtons = mcQuizOptionsContainer.querySelectorAll('.quiz-option'); const mcQuizResultsContainer = document.getElementById('mc-quiz-results-container'); const mcQuizScoreDisplay = document.getElementById('mc-quiz-score-display'); const mcQuizPrevBtn = document.getElementById('mc-quiz-prev-btn'); const mcQuizNextBtn = document.getElementById('mc-quiz-next-btn'); const finishMcQuizBtn = document.getElementById('finish-mc-quiz-btn'); const mcQuizAddUnfamiliarContainer = document.getElementById('mc-quiz-add-unfamiliar-container');
        const spellingQuizProgressBar = document.getElementById('spelling-quiz-progress-bar'); const spellingQuizQuestionArea = document.getElementById('spelling-quiz-question-area'); const spellingQuizQuestionDisplay = document.getElementById('spelling-quiz-question-display'); const spellingInputForm = document.getElementById('spelling-input-form'); const spellingInput = document.getElementById('spelling-input'); const spellingFeedback = document.getElementById('spelling-feedback'); const spellingSubmitBtn = document.getElementById('spelling-submit-btn'); const spellingQuizResultsContainer = document.getElementById('spelling-quiz-results-container'); const spellingQuizScoreDisplay = document.getElementById('spelling-quiz-score-display'); const spellingQuizPrevBtn = document.getElementById('spelling-quiz-prev-btn'); const spellingQuizNextBtn = document.getElementById('spelling-quiz-next-btn'); const finishSpellingQuizBtn = document.getElementById('finish-spelling-quiz-btn'); const spellingQuizAddUnfamiliarContainer = document.getElementById('spelling-quiz-add-unfamiliar-container');
        const backToModeSelectionBtns = document.querySelectorAll('.back-to-mode-selection-btn');
        const wordSelectionModal = document.getElementById('word-selection-modal'); const wordSelectionListContainer = document.getElementById('word-selection-list-container'); const wordSelectAllBtn = document.getElementById('word-select-all-btn'); const wordSelectNoneBtn = document.getElementById('word-select-none-btn'); const confirmWordSelectionBtn = document.getElementById('confirm-word-selection-btn');
        
        // Modals and Settings Elements
        const addWordModal = document.getElementById('add-word-modal'); const addWordForm = document.getElementById('add-word-form'); const newWordEnglishInput = document.getElementById('new-word-english'); const newWordChineseInput = document.getElementById('new-word-chinese'); const addWordFeedback = addWordModal.querySelector('.add-word-feedback'); const editWordModal = document.getElementById('edit-word-modal'); const editWordForm = document.getElementById('edit-word-form'); const editWordEnglishInput = document.getElementById('edit-word-english'); const editWordChineseInput = document.getElementById('edit-word-chinese'); const confirmModal = document.getElementById('confirm-modal'); const confirmModalTitle = document.getElementById('confirm-modal-title'); const confirmModalText = document.getElementById('confirm-modal-text'); const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn'); const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const openSettingsBtn = document.getElementById('open-settings-btn'); const settingsModal = document.getElementById('settings-modal');
        let currentThemeSettings = {}; let themeBeforeEdit = {};
        const PRESET_THEMES = { default: { name: '預設綠', primary: '#4CAF50', background: '#f4f7f6', text: '#333333', accent: '#03A9F4', opacity: 95 }, azureWave: { name: '蔚藍浪潮', primary: '#2962FF', background: 'linear-gradient(to right, #72EDF2, #5151E5)', text: '#FFFFFF', accent: '#001F3F', opacity: 10 }, emeraldGrove: { name: '翡翠之森', primary: '#26A69A', background: 'linear-gradient(to top, #134E5E, #71B280)', text: '#FFFFFF', accent: '#FFC107', opacity: 10 }, sakuraTwilight: { name: '櫻花薄暮', primary: '#C2185B', background: 'linear-gradient(to top, #a18cd1, #fbc2eb)', text: '#FFFFFF', accent: '#FFB6C1', opacity: 10 }, midnightNova: { name: '午夜新星', primary: '#00E5FF', background: 'linear-gradient(to bottom, #0d1117, #161b22)', text: '#FFFFFF', accent: '#F50057', opacity: 10 } };
        
        const shuffleArray = (array) => { let t=[...array],c=t.length,r;while(0!==c){r=Math.floor(Math.random()*c);c--;[t[c],t[r]]=[t[r],t[c]]}return t; };
        
        // --- App State & Theme Management ---
        function saveAppState() { try { localStorage.setItem('allWordDecks', JSON.stringify(allWordCategoriesData)); } catch (e) { console.error("無法保存單字包列表。", e); } }
        function loadAppState() { let loadedDecks = {}; try { const savedDecks = localStorage.getItem('allWordDecks'); if (savedDecks) { const parsed = JSON.parse(savedDecks); if (typeof parsed === 'object' && parsed !== null) { loadedDecks = parsed; } } } catch (e) { console.error("載入單字包列表失敗，將重置。", e); loadedDecks = {}; } if (!loadedDecks.hasOwnProperty(DEFAULT_DECK_NAME)) { loadedDecks[DEFAULT_DECK_NAME] = []; } allWordCategoriesData = loadedDecks; }
        async function loadDefaultDecksFromServer() { try { const indexResponse = await fetch('./cardholder/index.json'); if (!indexResponse.ok) { return; } const deckFilenames = await indexResponse.json(); const fetchPromises = deckFilenames.map(filename => { const deckName = filename.replace(/\.json$/i, ''); if (!allWordCategoriesData.hasOwnProperty(deckName)) { return fetch(`./cardholder/${filename}`).then(res => res.json()); } return Promise.resolve(null); }); const newDecksData = await Promise.all(fetchPromises); let decksAdded = false; newDecksData.forEach((deckContent, index) => { if (deckContent) { const deckName = deckFilenames[index].replace(/\.json$/i, ''); allWordCategoriesData[deckName] = deckContent; decksAdded = true; } }); if (decksAdded) { saveAppState(); } } catch (error) { console.error("Error loading default decks from server:", error); } }
        function applyTheme(theme) { const root = document.documentElement; const safeTheme = { ...PRESET_THEMES.default, ...theme }; root.style.setProperty('--primary-color', safeTheme.primary); root.style.setProperty('--primary-color-darker', chroma(safeTheme.primary).darken(0.6).hex()); root.style.setProperty('--accent-color', safeTheme.accent); root.style.setProperty('--accent-color-darker', chroma(safeTheme.accent).darken(0.6).hex()); if (safeTheme.background && safeTheme.background.includes('gradient')) { root.style.setProperty('--bg-image', safeTheme.background); const fallbackColor = safeTheme.background.match(/#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})/g)[0] || '#f4f7f6'; root.style.setProperty('--background-color', fallbackColor); } else { root.style.setProperty('--bg-image', 'none'); root.style.setProperty('--background-color', safeTheme.background); } const isDarkBg = chroma(getComputedStyle(root).getPropertyValue('--background-color')).luminance() < 0.5; root.style.setProperty('--text-color', safeTheme.text || (isDarkBg ? '#FFFFFF' : '#333333')); root.style.setProperty('--text-color-light', chroma.contrast(safeTheme.accent, isDarkBg ? '#fff' : '#000') < 2.5 ? (isDarkBg ? '#000' : '#fff') : '#fff'); root.style.setProperty('--card-background', isDarkBg ? chroma(getComputedStyle(root).getPropertyValue('--background-color')).brighten(0.5).hex() : '#fff'); root.style.setProperty('--container-opacity-percent', `${safeTheme.opacity}%`); root.style.setProperty('--text-color-muted', isDarkBg ? '#b0b0b0' : '#6c7a89'); if (safeTheme.backgroundImageDataUrl) { root.style.setProperty('--bg-image', `url(${safeTheme.backgroundImageDataUrl})`); root.style.setProperty('--bg-blur', '2px'); } else if (!safeTheme.background.includes('gradient')) { root.style.setProperty('--bg-image', 'none'); root.style.setProperty('--bg-blur', '0px'); } const themeColorMeta = document.querySelector('meta[name="theme-color"]'); if(themeColorMeta) themeColorMeta.setAttribute('content', safeTheme.primary); }
        function loadAndApplyTheme() { let loadedTheme = {}; try { const savedTheme = localStorage.getItem('flashcardTheme'); if (savedTheme) { loadedTheme = JSON.parse(savedTheme); } } catch (e) { console.error("Error loading theme, reverting to default.", e); } currentThemeSettings = { ...PRESET_THEMES.default, ...loadedTheme }; applyTheme(currentThemeSettings); }
        function saveProgress() { try { localStorage.setItem('unfamiliarWordsList', JSON.stringify(unfamiliarWordsInNormalCycle)); } catch (e) { console.error("無法保存不熟單字列表。", e); } }
        function loadUnfamiliarWords() { try { const s = localStorage.getItem('unfamiliarWordsList'); unfamiliarWordsInNormalCycle = s ? JSON.parse(s) : []; } catch (e) { console.error("載入不熟單字列表失敗。", e); unfamiliarWordsInNormalCycle = []; } }

        // --- View & UI Management ---
        function showView(viewName) { for (let id in views) { views[id].classList.remove('active'); } views[viewName].classList.add('active'); const showTopButtons = !['main-menu-view'].includes(viewName); backToMenuBtnTop.style.display = showTopButtons ? 'flex' : 'none'; fullscreenBtn.style.display = showTopButtons ? 'flex' : 'none'; if (viewName === 'main-menu-view') renderMainMenu(); }
        function renderMainMenu() { mainMenuContainer.innerHTML = ''; const createCategoryButton = (categoryName, specialClass = '') => { const item = document.createElement('div'); item.className = `category-item ${specialClass}`; item.innerHTML = `<span>${categoryName}</span><span class="manage-deck-btn" title="管理 '${categoryName}'">⚙️</span>`; item.querySelector('.manage-deck-btn').addEventListener('click', e => { e.stopPropagation(); openDeckManager(categoryName); }); item.addEventListener('click', () => startCategoryLearning(categoryName)); mainMenuContainer.appendChild(item); }; const customDeckNames = Object.keys(allWordCategoriesData).filter(name => name !== DEFAULT_DECK_NAME).sort(); customDeckNames.forEach(name => createCategoryButton(name)); if (allWordCategoriesData.hasOwnProperty(DEFAULT_DECK_NAME)) { createCategoryButton(DEFAULT_DECK_NAME, 'default-category'); } const unfamiliarItem = document.createElement('div'); unfamiliarItem.className = 'category-item unfamiliar-category'; unfamiliarItem.innerHTML = `<span>不熟單字</span> <span class="unfamiliar-count">${unfamiliarWordsInNormalCycle.length}</span>`; unfamiliarItem.addEventListener('click', startUnfamiliarReviewMode); mainMenuContainer.appendChild(unfamiliarItem); }
        
        // --- Modal & Deck Management ---
        function openAddWordModal(){addWordModal.classList.add("active"),setTimeout(()=>newWordEnglishInput.focus(),50)}function closeAddWordModal(){addWordForm.reset(),addWordFeedback.classList.remove("show"),clearTimeout(feedbackTimeout),addWordModal.classList.remove("active")}function openEditWordModal(t){editWordModal.dataset.originalEnglish=t.english,editWordEnglishInput.value=t.english,editWordChineseInput.value=t.chinese,editWordModal.classList.add("active"),setTimeout(()=>editWordEnglishInput.focus(),50)}function closeEditWordModal(){editWordForm.reset(),delete editWordModal.dataset.originalEnglish,editWordModal.classList.remove("active")}function showConfirmModal(t,e,o){confirmModalTitle.textContent=t,confirmModalText.innerHTML=e,confirmAction=o,confirmModal.classList.add("active")}function closeConfirmModal(){confirmModal.classList.remove("active"),confirmAction=null}function openDeckManager(t){currentManagingDeck=t,deckManagerTitle.textContent=`管理: ${t}`,deleteDeckBtn.disabled=t===DEFAULT_DECK_NAME,deleteDeckBtn.title=t===DEFAULT_DECK_NAME?"預設單字包無法刪除":"",renderWordList(t),showView("deck-management-view")}function renderWordList(t){wordListContainer.innerHTML="",selectedWordsToDelete.clear();const e=allWordCategoriesData[t]||[];0===e.length?wordListContainer.innerHTML='<p style="color: #888; padding: 20px 0; text-align: center;">這個單字包是空的。點擊右下角 + 來新增！</p>':e.forEach(t=>{const e=document.createElement("div");e.className="word-list-item",e.dataset.originalEnglish=t.english,e.innerHTML=`\n <input type="checkbox" class="word-select-checkbox" data-english="${t.english}">\n <div class="word-content-wrapper" title="點擊以編輯">\n <span><strong>${t.english}</strong>: ${t.chinese}</span>\n </div>`,wordListContainer.appendChild(e)}),updateMultiDeleteUI(),selectAllCheckbox.checked=!1}function handleWordSelectionChange(t){const e=t.target,o=e.dataset.english;e.checked?selectedWordsToDelete.add(o):selectedWordsToDelete.delete(o);const n=wordListContainer.querySelectorAll(".word-select-checkbox");selectAllCheckbox.checked=n.length>0&&selectedWordsToDelete.size===n.length,updateMultiDeleteUI()}function updateMultiDeleteUI(){const t=selectedWordsToDelete.size;multiDeleteBtn.disabled=0===t,multiDeleteBtn.textContent=`刪除已選 (${t})`}function handleDeleteDeck(){currentManagingDeck&&currentManagingDeck!==DEFAULT_DECK_NAME&&showConfirmModal("確認刪除單字包",`您確定要永久刪除「<strong>${currentManagingDeck}</strong>」這個單字卡包嗎？<br>此操作無法復原！`,()=>{delete allWordCategoriesData[currentManagingDeck],saveAppState(),alert(`單字卡包「${currentManagingDeck}」已刪除。`),navigateBack()})}function handleMultiDelete(){const t=selectedWordsToDelete.size;0!==t&&currentManagingDeck&&showConfirmModal("確認刪除單字",`確定要從 "${currentManagingDeck}" 中永久刪除這 <strong>${t}</strong> 個單字嗎？`,()=>{allWordCategoriesData[currentManagingDeck]=allWordCategoriesData[currentManagingDeck].filter(t=>!selectedWordsToDelete.has(t.english)),saveAppState(),renderWordList(currentManagingDeck)})}function handleAddWord(t){t.preventDefault();const e=newWordEnglishInput.value.trim(),o=newWordChineseInput.value.trim();if(!e||!o||!currentManagingDeck)return alert("英文和中文欄位都不能為空！");if(allWordCategoriesData[currentManagingDeck].some(t=>t.english.toLowerCase()===e.toLowerCase()))return alert(`單字 "${e}" 已存在！`);allWordCategoriesData[currentManagingDeck].push({english:e,chinese:o}),saveAppState(),renderWordList(currentManagingDeck),addWordFeedback.textContent="新增成功！",addWordFeedback.classList.add("show"),clearTimeout(feedbackTimeout),feedbackTimeout=setTimeout(()=>{addWordFeedback.classList.remove("show")},2e3),addWordForm.reset(),newWordEnglishInput.focus()}function handleEditWord(t){t.preventDefault();const e=editWordModal.dataset.originalEnglish,o=editWordEnglishInput.value.trim(),n=editWordChineseInput.value.trim();if(!o||!n)return alert("英文和中文欄位都不能為空！");if(allWordCategoriesData[currentManagingDeck].some(t=>t.english.toLowerCase()===o.toLowerCase()&&t.english.toLowerCase()!==e.toLowerCase()))return alert(`單字 "${o}" 已存在於此單字包中！`);const i=allWordCategoriesData[currentManagingDeck].findIndex(t=>t.english===e);i>-1?(allWordCategoriesData[currentManagingDeck][i]={english:o,chinese:n},saveAppState(),renderWordList(currentManagingDeck),closeEditWordModal()):alert("發生錯誤：找不到原始單字。")}function handleFileImport(){if(0===fileImporter.files.length)return alert("請先選擇一個或多個 .json 檔案！");for(const t of fileImporter.files){const e=new FileReader;e.onload=e=>{try{const o=JSON.parse(e.target.result);if(!Array.isArray(o)|o.length>0&&(!o[0].english||!o[0].chinese))throw new Error(`檔案 "${t.name}" 格式不正確。`);const n=t.name.replace(/\.json$/i,"");if(n===DEFAULT_DECK_NAME){if(!confirm(`您正試圖用檔案 "${t.name}" 覆蓋預設單字包 "${DEFAULT_DECK_NAME}"。\n確定要繼續嗎？`))return}else if(allWordCategoriesData[n]&&!confirm(`分類 "${n}" 已存在。是否要用檔案 "${t.name}" 的內容覆蓋它？`))return;allWordCategoriesData[n]=o,saveAppState(),renderMainMenu(),alert(`分類 "${n}" 已成功從檔案 "${t.name}" 匯入/更新！`)}catch(e){alert(`匯入檔案 "${t.name}" 失敗: `+e.message)}},e.onerror=()=>alert(`讀取檔案 "${t.name}" 時發生錯誤。`),e.readAsText(t)}fileImporter.value=""}
        function handleExportDeck(){if(!currentManagingDeck)return;const t=currentManagingDeck,e=allWordCategoriesData[t]||[];if(0===e.length)return void alert(`「${t}」是空的，沒有可匯出的單字。`);const o=JSON.stringify(e,null,2),n=new Blob([o],{type:"application/json"}),i=URL.createObjectURL(n),d=document.createElement("a");d.href=i,d.download=`${t}.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i)}

        // --- THEME SETTINGS FUNCTIONS ---
        function openSettingsModal(){themeBeforeEdit=JSON.parse(JSON.stringify(currentThemeSettings));updateThemeControlsUI(currentThemeSettings);generateAllThemesUI();settingsModal.classList.add('active')}function closeSettingsModal(isCancel = false){if(isCancel){applyTheme(themeBeforeEdit);currentThemeSettings = themeBeforeEdit;}settingsModal.classList.remove('active');}function handleSaveThemeAndClose(){try {localStorage.setItem('flashcardTheme', JSON.stringify(currentThemeSettings));} catch(e){alert("無法儲存主題設定。");}closeSettingsModal();}function generateThemeSwatch(theme, key, isCustom = false){const swatch=document.createElement("div");swatch.className="theme-swatch";swatch.dataset.themeKey=key;const colorDiv = document.createElement('div'); colorDiv.className = 'swatch-color'; if(theme.background&&theme.background.includes("gradient")){colorDiv.style.background=theme.background;}else{colorDiv.style.backgroundColor=theme.background;} swatch.appendChild(colorDiv); const labelDiv = document.createElement('div'); labelDiv.className = 'swatch-label'; labelDiv.textContent = theme.name; swatch.appendChild(labelDiv); swatch.addEventListener("click",()=>{currentThemeSettings={...theme,isCustom:isCustom};if(!isCustom)currentThemeSettings.presetKey=key;applyTheme(currentThemeSettings);updateThemeControlsUI(currentThemeSettings);});if(isCustom){swatch.dataset.customThemeName=theme.name;const deleteBtn=document.createElement("span");deleteBtn.className="delete-theme-btn";deleteBtn.innerHTML="&times;";deleteBtn.title=`刪除主題 "${theme.name}"`;deleteBtn.onclick=(e)=>{e.stopPropagation();if(confirm(`確定要刪除您儲存的主題 "${theme.name}" 嗎？`)){deleteCustomTheme(theme.name);}};swatch.appendChild(deleteBtn);}return swatch;}function generateAllThemesUI(){const presetContainer=document.getElementById("preset-themes-container");const userContainer=document.getElementById("user-themes-container");const userHeading=document.getElementById("user-themes-heading");presetContainer.innerHTML="";userContainer.innerHTML="";for(const key in PRESET_THEMES){presetContainer.appendChild(generateThemeSwatch(PRESET_THEMES[key],key,false));}const customThemes=getCustomThemes();if(customThemes.length>0){userHeading.style.display="block";customThemes.forEach(theme=>{userContainer.appendChild(generateThemeSwatch(theme,theme.name,true));});}else{userHeading.style.display="none";}updateActiveSwatchUI();}function updateActiveSwatchUI(){document.querySelectorAll(".theme-swatch").forEach(swatch=>{let isActive=false;if(currentThemeSettings.isCustom){isActive=swatch.dataset.customThemeName===currentThemeSettings.name;}else{isActive=swatch.dataset.themeKey===currentThemeSettings.presetKey;}swatch.classList.toggle("active",isActive);});}
        function updateThemeControlsUI(theme){const{primary,accent,background,opacity}=theme;document.getElementById("primary-color-picker").value=chroma(primary).hex();document.getElementById("accent-color-picker").value=chroma(accent).hex();if(background&&!background.includes("gradient")){document.getElementById("background-color-picker").value=chroma(background).hex();}document.getElementById("container-opacity-slider").value=opacity;document.getElementById("opacity-display").textContent=`${opacity}%`;document.getElementById("background-image-uploader").value="";updateActiveSwatchUI();}
        function handleCustomThemeChange(){currentThemeSettings={primary:document.getElementById("primary-color-picker").value,accent:document.getElementById("accent-color-picker").value,background:document.getElementById("background-color-picker").value,opacity:parseInt(document.getElementById("container-opacity-slider").value,10),backgroundImageDataUrl:currentThemeSettings.backgroundImageDataUrl,isCustom:true,name:"自訂"};applyTheme(currentThemeSettings);document.getElementById("opacity-display").textContent=`${currentThemeSettings.opacity}%`;document.querySelectorAll(".theme-swatch").forEach(s=>s.classList.remove("active"));}function getCustomThemes(){try{return JSON.parse(localStorage.getItem("userSavedThemes")||"[]");}catch{return[];}}
        function saveCustomThemes(themes){try{localStorage.setItem("userSavedThemes",JSON.stringify(themes));}catch(e){console.error("Error saving custom themes",e);}}
        function handleSaveCustomTheme(){const themeName=prompt("請為您的新主題命名：","我的主題");if(!themeName)return;const themes=getCustomThemes();const existingIndex=themes.findIndex(t=>t.name===themeName);if(existingIndex>-1&&!confirm(`已存在名為 "${themeName}" 的主題。您要覆蓋它嗎？`))return;const newTheme={...currentThemeSettings,name:themeName};if(existingIndex>-1){themes[existingIndex]=newTheme;}else{themes.push(newTheme);}saveCustomThemes(themes);alert(`主題 "${themeName}" 已儲存！`);generateAllThemesUI();updateThemeControlsUI(newTheme);}
        function deleteCustomTheme(themeName){let themes=getCustomThemes();themes=themes.filter(t=>t.name!==themeName);saveCustomThemes(themes);generateAllThemesUI();}
        
        // --- Word Selection Modal Logic ---
        function openWordSelectionModal() {
            const words = allWordCategoriesData[currentCategoryName] || [];
            wordSelectionListContainer.innerHTML = '';
            if (words.length === 0) {
                wordSelectionListContainer.innerHTML = '<p>此單字包目前沒有單字。</p>';
            } else {
                words.forEach(word => {
                    const item = document.createElement('label');
                    item.className = 'word-selection-item';
                    const isChecked = selectedWordsForSession.size === 0 || selectedWordsForSession.has(word.english);
                    item.innerHTML = `<input type="checkbox" data-english="${word.english}" ${isChecked ? 'checked' : ''}><span><strong>${word.english}</strong>: ${word.chinese}</span>`;
                    item.querySelector('input').addEventListener('change', (e) => {
                        const wordEnglish = e.target.dataset.english;
                        if (e.target.checked) selectedWordsForSession.add(wordEnglish); else selectedWordsForSession.delete(wordEnglish);
                    });
                    wordSelectionListContainer.appendChild(item);
                });
            }
            wordSelectionModal.classList.add('active');
        }
        function closeWordSelectionModal() { wordSelectionModal.classList.remove('active'); }
        
        // --- Learning Flow & Logic ---
        function filterAndPrepareWords(wordList) { if (!wordList) return []; const flatList = Object.values(allWordCategoriesData).flat(); return wordList.filter(w => flatList.some(ow => ow.english === w.english && ow.chinese === w.chinese)).map(w => ({...w, revealed: w.revealed || false})); };
        function getSelectedWordsForSession() { const baseWords = allWordCategoriesData[currentCategoryName]; if (selectedWordsForSession.size > 0) { return baseWords.filter(w => selectedWordsForSession.has(w.english)); } return [...baseWords]; }
        function startCategoryLearning(categoryName) {
            currentCategoryName = categoryName;
            currentWordsSource = allWordCategoriesData[categoryName];
            if (!currentWordsSource || currentWordsSource.length === 0) { alert(`"${categoryName}" 類別目前沒有單字！\n請點擊右方的 ⚙️ 圖示來新增或管理單字。`); return; }
            selectedWordsForSession.clear(); selectedDeckNameDisplay.textContent = `單字包: ${currentCategoryName}`; showView('mode-selection-view');
        }
        function goToLanguageSelection(modeType, modeName) { pendingLearningMode = { type: modeType, name: modeName }; selectedDeckAndModeDisplay.textContent = `${currentCategoryName} · ${modeName}`; showView('language-direction-view'); }
        function startSessionFromLanguageChoice(lang) {
            currentStudyMode = lang;
            if (pendingLearningMode.type === 'reading' || pendingLearningMode.type === 'spelling') { if (lang === 'en-first' && pendingLearningMode.type === 'spelling') { alert('拼寫測驗僅支援「先顯示中文」模式。'); return; } currentStudyMode = 'zh-first'; }
            if (pendingLearningMode.type === 'basic') startLearningSession(false); else if (pendingLearningMode.type === 'shuffle') startLearningSession(true); else if (pendingLearningMode.type === 'reading') startReadingSession(); else if (pendingLearningMode.type === 'mc-quiz') startMcQuizSession(); else if (pendingLearningMode.type === 'spelling') startSpellingQuizSession();
        }
        function startLearningSession(isShuffled) { isReadingMode = false; const wordsToLearn = getSelectedWordsForSession(); if (wordsToLearn.length === 0) { alert('沒有選擇任何單字來學習！'); return; } currentMode = 'normal'; const preparedWords = wordsToLearn.map(w => ({ ...w, revealed: false })); shuffledWords = isShuffled ? shuffleArray(preparedWords) : preparedWords; currentIndex = 0; displayCard(); showView('flashcard-view'); }
        function startReadingSession() { isReadingMode = true; const wordsToLearn = getSelectedWordsForSession(); if (wordsToLearn.length === 0) { alert('沒有選擇任何單字來閱讀！'); return; } currentMode = 'normal'; shuffledWords = wordsToLearn.map(w => ({ ...w, revealed: true })); currentIndex = 0; displayCard(); showView('flashcard-view'); }

        // --- MC Quiz Logic ---
        function startMcQuizSession() { mcQuizResultsContainer.style.display = 'none'; mcQuizQuestionArea.style.display = 'flex'; mcQuizProgressBar.style.width = '0%'; const words = getSelectedWordsForSession(); const allWordsInDeck = allWordCategoriesData[currentCategoryName]; if (words.length < 1) { alert('請至少選擇1個單字進行測驗。'); showView('mode-selection-view'); return; } if (allWordsInDeck.length < 4) { alert('選擇測驗需要單字包中至少有4個單字才能生成選項。'); showView('mode-selection-view'); return; } mcQuizQuestions = shuffleArray(words).map(word => { const correctAnswer = currentStudyMode === 'en-first' ? word.chinese : word.english; let distractors = allWordsInDeck.filter(w => w.english !== word.english).map(w => currentStudyMode === 'en-first' ? w.chinese : w.english); distractors = shuffleArray(distractors).slice(0, 3); const options = shuffleArray([...distractors, correctAnswer]); return { originalWord: word, question: currentStudyMode === 'en-first' ? word.english : word.chinese, options: options, correctAnswer: correctAnswer }; }); currentMcQuizIndex = 0; mcQuizUserAnswers = new Array(mcQuizQuestions.length).fill(null); incorrectMcQuizWords.clear(); displayMcQuizQuestion(); showView('mc-quiz-view');}
        function displayMcQuizQuestion() { if (currentMcQuizIndex < 0 || currentMcQuizIndex >= mcQuizQuestions.length) return; const q = mcQuizQuestions[currentMcQuizIndex]; mcQuizQuestionDisplay.textContent = q.question; const userAnswer = mcQuizUserAnswers[currentMcQuizIndex]; mcQuizOptionButtons.forEach((btn, index) => { btn.textContent = q.options[index]; btn.className = 'quiz-option'; btn.disabled = !!userAnswer; if (userAnswer) { if (btn.textContent === q.correctAnswer) btn.classList.add('correct'); else if (btn.textContent === userAnswer) btn.classList.add('incorrect'); } }); mcQuizProgressBar.style.width = `${((currentMcQuizIndex + 1) / mcQuizQuestions.length) * 100}%`; mcQuizPrevBtn.disabled = currentMcQuizIndex === 0; mcQuizNextBtn.style.display = currentMcQuizIndex === mcQuizQuestions.length - 1 ? 'none' : 'inline-block'; finishMcQuizBtn.style.display = currentMcQuizIndex === mcQuizQuestions.length - 1 ? 'inline-block' : 'none';}
        function handleMcQuizAnswer(event) { if (mcQuizUserAnswers[currentMcQuizIndex] !== null) return; const selectedButton = event.target; const userAnswer = selectedButton.textContent; mcQuizUserAnswers[currentMcQuizIndex] = userAnswer; const q = mcQuizQuestions[currentMcQuizIndex]; const isCorrect = userAnswer === q.correctAnswer; if (!isCorrect) { incorrectMcQuizWords.add(q.originalWord); } displayMcQuizQuestion(); if (isCorrect) { setTimeout(showNextMcQuizQuestion, 1200); }}
        function showNextMcQuizQuestion() { if (currentMcQuizIndex < mcQuizQuestions.length - 1) { currentMcQuizIndex++; displayMcQuizQuestion(); }}
        function showMcQuizResults() { let score = 0; for(let i=0; i<mcQuizQuestions.length; i++) { if(mcQuizUserAnswers[i] === mcQuizQuestions[i].correctAnswer) score++; } mcQuizScoreDisplay.textContent = `${score} / ${mcQuizQuestions.length}`; mcQuizAddUnfamiliarContainer.innerHTML = ''; if (incorrectMcQuizWords.size > 0) { const btn = document.createElement('button'); btn.id = 'add-incorrect-to-unfamiliar-btn'; btn.textContent = `將答錯的 ${incorrectMcQuizWords.size} 個單字加入不熟列表`; btn.onclick = () => { incorrectMcQuizWords.forEach(word => { if (!unfamiliarWordsInNormalCycle.some(uw => uw.english === word.english)) { unfamiliarWordsInNormalCycle.push({ ...word, revealed: false }); } }); saveProgress(); alert(`${incorrectMcQuizWords.size} 個單字已加入不熟列表！`); btn.disabled = true; btn.textContent = '已加入'; }; mcQuizAddUnfamiliarContainer.appendChild(btn); } mcQuizResultsContainer.style.display = 'flex'; mcQuizQuestionArea.style.display = 'none';}
        
        // --- Spelling Quiz Logic ---
        function startSpellingQuizSession() { spellingQuizResultsContainer.style.display = 'none'; spellingQuizQuestionArea.style.display = 'flex'; spellingQuizProgressBar.style.width = '0%'; const words = getSelectedWordsForSession(); if (words.length < 1) { alert('請至少選擇1個單字進行測驗。'); showView('mode-selection-view'); return; } spellingQuizQuestions = shuffleArray(words.map(w => ({...w}))); currentSpellingQuizIndex = 0; spellingQuizUserAnswers = new Array(spellingQuizQuestions.length).fill(null); incorrectSpellingQuizWords.clear(); displaySpellingQuizQuestion(); showView('spelling-quiz-view');}
        function displaySpellingQuizQuestion() { if (currentSpellingQuizIndex < 0 || currentSpellingQuizIndex >= spellingQuizQuestions.length) return; const q = spellingQuizQuestions[currentSpellingQuizIndex]; spellingQuizQuestionDisplay.textContent = q.chinese; const userAnswer = spellingQuizUserAnswers[currentSpellingQuizIndex]; if (userAnswer !== null) { spellingInput.value = userAnswer.answer; spellingInput.disabled = true; spellingSubmitBtn.disabled = true; if (userAnswer.isCorrect) { spellingFeedback.textContent = '正確！'; spellingFeedback.className = 'feedback-correct'; } else { spellingFeedback.innerHTML = `您輸入: ${userAnswer.answer}<br>正確答案是: <strong>${q.english}</strong>`; spellingFeedback.className = 'feedback-incorrect'; } } else { spellingInput.value = ''; spellingInput.disabled = false; spellingSubmitBtn.disabled = false; spellingFeedback.innerHTML = ''; setTimeout(() => spellingInput.focus(), 100); } spellingQuizProgressBar.style.width = `${((currentSpellingQuizIndex + 1) / spellingQuizQuestions.length) * 100}%`; spellingQuizPrevBtn.disabled = currentSpellingQuizIndex === 0; spellingQuizNextBtn.style.display = currentSpellingQuizIndex === spellingQuizQuestions.length - 1 ? 'none' : 'inline-block'; finishSpellingQuizBtn.style.display = currentSpellingQuizIndex === spellingQuizQuestions.length - 1 ? 'inline-block' : 'none';}
        function handleSpellingQuizSubmit(event) { event.preventDefault(); if (spellingQuizUserAnswers[currentSpellingQuizIndex] !== null) return; const userAnswer = spellingInput.value.trim(); const correctAnswer = spellingQuizQuestions[currentSpellingQuizIndex].english; const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase(); spellingQuizUserAnswers[currentSpellingQuizIndex] = { answer: userAnswer, isCorrect: isCorrect }; if (!isCorrect) { incorrectSpellingQuizWords.add(spellingQuizQuestions[currentSpellingQuizIndex]); } displaySpellingQuizQuestion(); if(isCorrect) { setTimeout(showNextSpellingQuizQuestion, 1500); }}
        function showNextSpellingQuizQuestion() { if (currentSpellingQuizIndex < spellingQuizQuestions.length - 1) { currentSpellingQuizIndex++; displaySpellingQuizQuestion(); }}
        function showSpellingQuizResults() { let score = spellingQuizUserAnswers.filter(a => a && a.isCorrect).length; spellingQuizScoreDisplay.textContent = `${score} / ${spellingQuizQuestions.length}`; spellingQuizAddUnfamiliarContainer.innerHTML = ''; if (incorrectSpellingQuizWords.size > 0) { const btn = document.createElement('button'); btn.id = 'add-incorrect-to-unfamiliar-btn'; btn.textContent = `將答錯的 ${incorrectSpellingQuizWords.size} 個單字加入不熟列表`; btn.onclick = () => { incorrectSpellingQuizWords.forEach(word => { if (!unfamiliarWordsInNormalCycle.some(uw => uw.english === word.english)) { unfamiliarWordsInNormalCycle.push({ ...word, revealed: false }); } }); saveProgress(); alert(`${incorrectSpellingQuizWords.size} 個單字已加入不熟列表！`); btn.disabled = true; btn.textContent = '已加入'; }; spellingQuizAddUnfamiliarContainer.appendChild(btn); } spellingQuizResultsContainer.style.display = 'flex'; spellingQuizQuestionArea.style.display = 'none';}

        // --- Unfamiliar Mode & Speech ---
        function startUnfamiliarReviewMode() { const validUnfamiliarWords = filterAndPrepareWords(unfamiliarWordsInNormalCycle); if (validUnfamiliarWords.length !== unfamiliarWordsInNormalCycle.length) { unfamiliarWordsInNormalCycle = validUnfamiliarWords; saveProgress(); } if (unfamiliarWordsInNormalCycle.length === 0) { alert('目前沒有不熟的單字可以複習！'); return; } currentCategoryName = '不熟單字'; currentMode = 'review'; shuffledWords = shuffleArray(unfamiliarWordsInNormalCycle.map(w => ({ ...w, revealed: false }))); currentIndex = 0; displayCard(); showView('flashcard-view'); }
        function handleSpeakWord(event) { event.stopPropagation(); if (shuffledWords.length === 0) return; const wordToSpeak = shuffledWords[currentIndex].english; if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(wordToSpeak); utterance.lang = 'en-US'; window.speechSynthesis.speak(utterance); } else { alert('您的瀏覽器不支援語音合成功能。'); } }
        
        // --- Flashcard Display & Interaction ---
        function displayCard() {
            if (shuffledWords.length === 0) { wordDisplay.textContent = "此類別沒有單字。"; translationDisplay.textContent = ""; translationDisplay.style.display = 'none'; currentCountSpan.textContent = 0; totalCountSpan.textContent = 0; markUnfamiliarBtn.style.display = 'none'; modeDisplay.textContent = "完成！"; flashcard.classList.remove('revealed-background', 'reading-mode-card'); bookmarkIcon.style.display = 'none'; speakBtn.style.display = 'none'; return; }
            speakBtn.style.display = 'block'; const currentWord = shuffledWords[currentIndex]; let frontText, backText;
            flashcard.classList.toggle('reading-mode-card', isReadingMode); markUnfamiliarBtn.style.display = isReadingMode ? 'none' : 'block';
            if (isReadingMode) { frontText = currentWord.english; backText = currentWord.chinese; } 
            else if (currentStudyMode === 'zh-first') { frontText = currentWord.chinese; backText = currentWord.english; } 
            else { frontText = currentWord.english; backText = currentWord.chinese; }
            wordDisplay.textContent = frontText; translationDisplay.textContent = backText;
            if (currentWord.revealed) { translationDisplay.style.display = 'block'; flashcard.classList.add('revealed-background'); } else { translationDisplay.style.display = 'none'; flashcard.classList.remove('revealed-background'); }
            const isBookmarked = unfamiliarWordsInNormalCycle.some(w => w.english === currentWord.english); 
            bookmarkIcon.style.display = isBookmarked ? 'block' : 'none';
            updateProgress(); updateButtonText();
            modeDisplay.textContent = currentMode === 'normal' ? `學習模式: ${currentCategoryName}` : '複習模式: 不熟單字';
        }
        function handleCardClick(event) { if (shuffledWords.length === 0) return; const cardWidth = flashcard.offsetWidth; const clickX = event.clientX - flashcard.getBoundingClientRect().left; const currentWordObj = shuffledWords[currentIndex]; if (clickX < cardWidth / 2) { showPreviousWord(); } else { if (!currentWordObj.revealed) { translationDisplay.style.display = 'block'; flashcard.classList.add('revealed-background'); currentWordObj.revealed = true; } else { showNextWord(); } } }
        function showPreviousWord() { if (shuffledWords.length > 0 && currentIndex > 0) { currentIndex--; displayCard(); } }
        function showNextWord() { if (shuffledWords.length > 0) { currentIndex++; if (currentIndex >= shuffledWords.length) handleCycleEnd(); else displayCard(); } }
        function handleCycleEnd() { if (currentMode === 'normal') { if (unfamiliarWordsInNormalCycle.length > 0 && confirm(`"${currentCategoryName}"單字已看過一次！是否要跳到複習不熟的單字？`)) { startUnfamiliarReviewMode(); } else { alert(`"${currentCategoryName}"單字已看過一次！即將返回模式選擇。`); showView('mode-selection-view'); } } else { if (confirm('不熟單字已複習完畢！是否要再次複習這些單字？')) { startUnfamiliarReviewMode(); } else { alert('即將返回主菜單。'); showView('main-menu-view'); } } }
        function handleUnfamiliarAction() { if (shuffledWords.length === 0) return; const currentWord = shuffledWords[currentIndex]; const isBookmarked = unfamiliarWordsInNormalCycle.some(word => word.english === currentWord.english); if (currentMode === 'normal') { if (!isBookmarked) { unfamiliarWordsInNormalCycle.push({ ...currentWord, revealed: false }); } else { unfamiliarWordsInNormalCycle = unfamiliarWordsInNormalCycle.filter(word => word.english !== currentWord.english); } } else { unfamiliarWordsInNormalCycle = unfamiliarWordsInNormalCycle.filter(word => word.english !== currentWord.english); shuffledWords.splice(currentIndex, 1); if (shuffledWords.length === 0) { currentIndex = 0; handleCycleEnd(); return; } else if (currentIndex >= shuffledWords.length) { currentIndex = shuffledWords.length - 1; } } saveProgress(); renderMainMenu(); displayCard(); }
        function updateButtonText() { if (shuffledWords.length === 0 || isReadingMode) return; const isBookmarked = unfamiliarWordsInNormalCycle.some(w => w.english === shuffledWords[currentIndex].english); if (currentMode === 'normal') { markUnfamiliarBtn.classList.remove('delete-mode'); markUnfamiliarBtn.textContent = isBookmarked ? '取消標記不熟' : '標記為不熟'; markUnfamiliarBtn.classList.toggle('unmark-mode', isBookmarked); } else { markUnfamiliarBtn.textContent = '刪除不熟'; markUnfamiliarBtn.classList.add('delete-mode'); markUnfamiliarBtn.classList.remove('unmark-mode'); } }
        function updateProgress() { currentCountSpan.textContent = shuffledWords.length > 0 ? currentIndex + 1 : 0; totalCountSpan.textContent = shuffledWords.length; }
        
        // --- Navigation ---
        function resetSessionState() { isReadingMode = false; mcQuizQuestions = []; spellingQuizQuestions = []; pendingLearningMode = {}; selectedWordsForSession.clear(); }
        function navigateBack() { const activeView = document.querySelector('.view.active'); if (!activeView) { showView('main-menu-view'); return; } const currentViewId = activeView.id; switch(currentViewId) { case 'flashcard-view': case 'mc-quiz-view': case 'spelling-quiz-view': case 'language-direction-view': showView('mode-selection-view'); break; case 'mode-selection-view': case 'deck-management-view': backToMainMenu(); break; default: backToMainMenu(); } }
        function backToMainMenu() { resetSessionState(); currentManagingDeck = null; showView('main-menu-view'); }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => alert(`無法進入全螢幕模式: ${err.message}`)); else document.exitFullscreen(); }
        
        // --- Initialization ---
        async function init() {
            const chromaScript = document.createElement('script');
            chromaScript.src = "https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js";
            chromaScript.onload = async () => {
                if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err)); }); }
                loadAndApplyTheme(); loadAppState(); await loadDefaultDecksFromServer(); loadUnfamiliarWords(); showView('main-menu-view');
                
                // --- Event Listeners ---
                backToMenuBtnTop.addEventListener('click', navigateBack); 
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                importBtn.addEventListener('click', handleFileImport);
                startBasicModeBtn.addEventListener('click', () => goToLanguageSelection('basic', '基礎模式'));
                startShuffleModeBtn.addEventListener('click', () => goToLanguageSelection('shuffle', '洗牌模式'));
                startReadingModeBtn.addEventListener('click', () => goToLanguageSelection('reading', '閱讀模式'));
                startMcQuizBtn.addEventListener('click', () => goToLanguageSelection('mc-quiz', '選擇測驗'));
                startSpellingQuizBtn.addEventListener('click', () => goToLanguageSelection('spelling', '拼寫測驗'));
                startEnFirstBtn.addEventListener('click', () => startSessionFromLanguageChoice('en-first'));
                startZhFirstBtn.addEventListener('click', () => startSessionFromLanguageChoice('zh-first'));
                backToModeSelectionBtns.forEach(btn => btn.addEventListener('click', () => showView('mode-selection-view')));
                
                // Flashcard Listeners
                flashcard.addEventListener('click', handleCardClick);
                speakBtn.addEventListener('click', handleSpeakWord);
                markUnfamiliarBtn.addEventListener('click', handleUnfamiliarAction);
                
                // Quiz Listeners
                mcQuizOptionsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('quiz-option')) handleMcQuizAnswer(e); });
                mcQuizPrevBtn.addEventListener('click', () => { if (currentMcQuizIndex > 0) { currentMcQuizIndex--; displayMcQuizQuestion(); } });
                mcQuizNextBtn.addEventListener('click', () => {
                    if (mcQuizUserAnswers[currentMcQuizIndex] === null) {
                        mcQuizUserAnswers[currentMcQuizIndex] = 'skipped'; 
                        incorrectMcQuizWords.add(mcQuizQuestions[currentMcQuizIndex].originalWord);
                        displayMcQuizQuestion();
                        setTimeout(showNextMcQuizQuestion, 1500); 
                    } else { showNextMcQuizQuestion(); }
                });
                finishMcQuizBtn.addEventListener('click', showMcQuizResults);
                spellingInputForm.addEventListener('submit', handleSpellingQuizSubmit);
                spellingQuizPrevBtn.addEventListener('click', () => { if (currentSpellingQuizIndex > 0) { currentSpellingQuizIndex--; displaySpellingQuizQuestion(); } });
                spellingQuizNextBtn.addEventListener('click', () => {
                    if (spellingQuizUserAnswers[currentSpellingQuizIndex] === null) {
                        spellingQuizUserAnswers[currentSpellingQuizIndex] = { answer: '(未作答)', isCorrect: false };
                        incorrectSpellingQuizWords.add(spellingQuizQuestions[currentSpellingQuizIndex]);
                        displaySpellingQuizQuestion();
                        setTimeout(showNextSpellingQuizQuestion, 2000); 
                    } else { showNextSpellingQuizQuestion(); }
                });
                finishSpellingQuizBtn.addEventListener('click', showSpellingQuizResults);

                // Word Selection Modal Listeners
                openWordSelectionBtn.addEventListener('click', openWordSelectionModal);
                confirmWordSelectionBtn.addEventListener('click', closeWordSelectionModal);
                wordSelectAllBtn.addEventListener('click', () => { wordSelectionListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = true; selectedWordsForSession.add(cb.dataset.english); }); });
                wordSelectNoneBtn.addEventListener('click', () => { wordSelectionListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; }); selectedWordsForSession.clear(); });
                
                // Deck Management Listeners
                deleteDeckBtn.addEventListener('click', handleDeleteDeck); 
                exportDeckBtn.addEventListener('click', handleExportDeck); 
                multiDeleteBtn.addEventListener('click', handleMultiDelete); 
                selectAllCheckbox.addEventListener('change', (e) => { wordListContainer.querySelectorAll('.word-select-checkbox').forEach(checkbox => { if (checkbox.checked !== e.target.checked) { checkbox.checked = e.target.checked; checkbox.dispatchEvent(new Event('change', { bubbles: true })); } }); }); 
                wordListContainer.addEventListener('click', (e) => { const item = e.target.closest('.word-list-item'); if (!item || e.target.classList.contains('word-select-checkbox')) return; const originalEng = item.dataset.originalEnglish; const word = allWordCategoriesData[currentManagingDeck].find(w => w.english === originalEng); if (word) { openEditWordModal(word); } }); 
                wordListContainer.addEventListener('change', (e) => { if (e.target.classList.contains('word-select-checkbox')) handleWordSelectionChange(e); });
                
                // Modals & Settings Listeners
                openAddWordModalBtn.addEventListener('click', openAddWordModal); 
                addWordForm.addEventListener('submit', handleAddWord); 
                editWordForm.addEventListener('submit', handleEditWord);
                confirmModalConfirmBtn.addEventListener('click', () => { if (typeof confirmAction === 'function') confirmAction(); closeConfirmModal(); }); 
                confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
                
                // **FIX**: Added back the listener for the settings button
                openSettingsBtn.addEventListener('click', openSettingsModal);

                [addWordModal, editWordModal, confirmModal, settingsModal, wordSelectionModal].forEach(modal => {
                    modal.querySelector('.modal-close-btn').addEventListener('click', () => {
                        if (modal.id === 'settings-modal') closeSettingsModal(true);
                        else {
                           if (modal.id === 'add-word-modal') closeAddWordModal();
                           else if (modal.id === 'edit-word-modal') closeEditWordModal();
                           else if (modal.id === 'confirm-modal') closeConfirmModal();
                           else if (modal.id === 'word-selection-modal') closeWordSelectionModal();
                           else modal.classList.remove('active');
                        }
                    });
                    modal.addEventListener('click', (e) => {
                         if (e.target === modal) {
                            if (modal.id === 'settings-modal') closeSettingsModal(true);
                            else {
                               if (modal.id === 'add-word-modal') closeAddWordModal();
                               else if (modal.id === 'edit-word-modal') closeEditWordModal();
                               else if (modal.id === 'confirm-modal') closeConfirmModal();
                               else if (modal.id === 'word-selection-modal') closeWordSelectionModal();
                               else modal.classList.remove('active');
                            }
                         }
                    });
                });
                document.getElementById('settings-save-btn').addEventListener('click', handleSaveThemeAndClose);
                document.getElementById('save-custom-theme-btn').addEventListener('click', handleSaveCustomTheme);
                ['primary-color-picker', 'accent-color-picker', 'background-color-picker', 'container-opacity-slider'].forEach(id => {
                    document.getElementById(id).addEventListener('input', handleCustomThemeChange);
                });
                document.getElementById('background-image-uploader').addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (ev) => { currentThemeSettings.backgroundImageDataUrl = ev.target.result; handleCustomThemeChange(); };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });
                document.getElementById('remove-bg-image-btn').addEventListener('click', () => { currentThemeSettings.backgroundImageDataUrl = null; document.getElementById('background-image-uploader').value = ''; handleCustomThemeChange(); });
                
                setInterval(saveProgress, 10000); 
            };
            document.head.appendChild(chromaScript);
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>