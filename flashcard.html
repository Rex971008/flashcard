<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的單字卡 (PWA 完善版)</title>
    
    <!-- PWA Modifications START -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#4CAF50">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#333333">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <!-- PWA Modifications END -->

    <style>
        :root {
            /* Default Theme (Green) */
            --primary-color: #4CAF50;
            --primary-color-darker: #388E3C;
            --accent-color: #03a9f4; /* For deck buttons and other accents */
            --accent-color-darker: #0288d1; /* Darker version of accent */
            --background-color: #f4f7f6;
            --card-background: #fff;
            --text-color: #333;
            --text-color-light: #fff;
            --text-color-muted: #6c7a89;
            --border-color: #ccc;
            --border-color-light: #ddd;
            --accent-red: #f44336;
            --accent-red-darker: #d32f2f;
            --accent-orange: #ff9800;
            --accent-yellow: #ffc107;
            --bg-image: none;
            --bg-blur: 0px;
            --container-opacity-percent: 95%; /* Container opacity */
        }

        html, body {
            height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; justify-content: center; align-items: center; 
            color: var(--text-color);
            background-color: var(--background-color);
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-color 0.3s ease, background-image 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            text-align: center; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 500px; width: 100%; height: 100vh; max-height: 800px; box-sizing: border-box; padding: 20px;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
            backdrop-filter: blur(var(--bg-blur));
            -webkit-backdrop-filter: blur(var(--bg-blur));
            background-color: color-mix(in srgb, var(--card-background) var(--container-opacity-percent), transparent);
            transition: background-color 0.3s ease;
        }
        h1 { color: var(--primary-color); margin-top: 0; margin-bottom: 20px; font-size: 2.5em; flex-shrink: 0; }
        .view {
            display: none; width: 100%; flex-grow: 1; overflow-y: auto; box-sizing: border-box;
            padding-bottom: 20px; flex-direction: column; align-items: center; position: relative;
        }
        .view.active { display: flex; }

        .main-menu-container {
            border: 2px solid var(--border-color); border-radius: 10px; padding: 20px; background-color: color-mix(in srgb, var(--background-color) 50%, transparent);
            width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; align-items: stretch;
        }
        .mode-selector {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; margin-top: 20px; background-color: color-mix(in srgb, var(--primary-color) 15%, transparent);
            border: 2px solid color-mix(in srgb, var(--primary-color) 40%, transparent); border-radius: 10px; box-sizing: border-box;
        }
        .mode-selector label { font-size: 1.1em; font-weight: bold; color: var(--primary-color-darker); }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .import-section, .settings-section {
            margin-top: 20px; padding: 15px; border: 2px dashed var(--accent-color); border-radius: 10px;
            background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); display: flex; flex-direction: column; gap: 10px; align-items: stretch;
        }
        .import-section label, .settings-section label { font-weight: bold; color: var(--accent-color-darker); }
        .import-section input[type="file"], .settings-section input[type="file"] { border: 1px solid var(--border-color); padding: 8px; border-radius: 5px; background-color: white; }
        .import-section button, .settings-section button { background-color: var(--accent-color); color: var(--text-color-light); }
        .category-item {
            padding: 15px 20px; font-size: 1.2em; border: none; border-radius: 8px; cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); font-weight: bold; color: var(--text-color-light);
            background-color: var(--accent-color);
            text-align: left; display: flex; flex-direction: row;
            justify-content: space-between; align-items: center;
        }
        .category-item:hover { transform: translateY(-2px); background-color: var(--accent-color-darker); }
        .category-item.unfamiliar-category { background-color: var(--accent-red); }
        .category-item.unfamiliar-category:hover { background-color: var(--accent-red-darker); }
        .category-item.default-category { background-color: #78909c; }
        .category-item.default-category:hover { background-color: #546e7a; }
        .unfamiliar-count, .manage-deck-btn {
            background-color: rgba(255, 255, 255, 0.3); border-radius: 5px;
            padding: 5px 10px; font-size: 0.9em; margin-left: 10px;
        }
        .manage-deck-btn { cursor: pointer; transition: background-color 0.2s; font-size: 1.1em; }
        .manage-deck-btn:hover { background-color: rgba(0, 0, 0, 0.2); }

        .flashcard-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; width: 100%; padding-top: 10px; box-sizing: border-box; }
        .flashcard { background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); border: 2px solid color-mix(in srgb, var(--primary-color) 40%, transparent); border-radius: 10px; width: min(80vw, 350px); height: min(80vw, 350px); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; box-sizing: border-box; overflow: hidden; text-align: center; flex-shrink: 0; position: relative; }
        .flashcard.revealed-background { background-color: color-mix(in srgb, var(--accent-yellow) 20%, transparent); }
        .word { font-size: 2.2em; font-weight: bold; color: var(--text-color); margin-bottom: 15px; word-wrap: break-word; padding: 0 10px; }
        .translation { font-size: 1.5em; color: var(--text-color-muted); font-weight: 500; word-wrap: break-word; display: none; padding: 0 10px; }
        .progress { font-size: 1em; color: #555; margin-top: 10px; }
        .progress span { font-weight: bold; color: var(--primary-color); }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 300px; flex-shrink: 0; }
        button { padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); font-weight: bold; }
        button:disabled { background-color: #bdbdbd; cursor: not-allowed; opacity: 0.7; }
        button:disabled:hover { background-color: #bdbdbd; }
        #mark-unfamiliar-btn { background-color: var(--accent-orange); color: var(--text-color-light); }
        #mark-unfamiliar-btn.unmark-mode { background-color: var(--accent-yellow); }
        #mark-unfamiliar-btn.delete-mode { background-color: var(--accent-red); }
        .top-button { position: absolute; top: 20px; z-index: 20; background-color: rgba(0, 0, 0, 0.3); color: var(--text-color-light); padding: 8px; font-size: 1.8em; border-radius: 5px; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); line-height: 1; cursor: pointer; border: none; flex-shrink: 0; }
        #back-to-menu-btn { left: 20px; }
        #fullscreen-btn { right: 20px; }
        #bookmark-icon { position: absolute; top: 10px; right: 10px; font-size: 1.5em; color: #e0b445; display: none; z-index: 5; }
        #speak-btn {
            position: absolute; bottom: 10px; right: 10px; font-size: 1.8em; color: var(--accent-color);
            cursor: pointer; z-index: 5; border: none; background: none; padding: 5px;
            transition: color 0.2s, transform 0.2s; display: none;
        }
        #speak-btn:hover { color: var(--accent-color-darker); transform: scale(1.1); }
        #deck-management-view { gap: 15px; justify-content: flex-start; align-items: stretch; }
        #deck-manager-title { color: var(--accent-color-darker); margin: 0 0 10px 0; flex-shrink: 0; text-align: center; }
        .deck-manager-actions {
            display: flex; justify-content: space-between; align-items: center; padding: 10px;
            border-bottom: 2px solid var(--border-color-light); background-color: #f5f5f5; flex-shrink: 0;
        }
        .deck-manager-actions label { display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer; }
        .deck-manager-actions input[type="checkbox"] { transform: scale(1.4); cursor: pointer; }
        #multi-delete-btn { background-color: var(--accent-red); color: var(--text-color-light); padding: 8px 15px; font-size: 1em; }
        #multi-delete-btn:hover:not(:disabled) { background-color: var(--accent-red-darker); }
        .word-list-container {
            width: 100%; flex-grow: 1; overflow-y: auto;
            border: 1px solid var(--border-color-light); border-radius: 8px; padding: 10px;
            background-color: color-mix(in srgb, var(--card-background) 50%, transparent); padding-bottom: 80px; box-sizing: border-box;
        }
        .word-list-item { 
            display: flex; justify-content: flex-start; align-items: center; 
            padding: 12px 10px; border-bottom: 1px solid var(--border-color-light); 
            font-size: 1.1em; gap: 15px; cursor: pointer;
            transition: background-color 0.2s;
        }
        .word-list-item:hover { background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); }
        .word-list-item:last-child { border-bottom: none; }
        .word-list-item .word-select-checkbox { transform: scale(1.5); flex-shrink: 0; cursor: pointer; }
        .word-content-wrapper { flex-grow: 1; text-align: left; }
        
        .deck-actions-container { margin-top: auto; display: flex; flex-direction: column; gap: 10px; }
        #export-deck-btn { background-color: var(--accent-color); color: var(--text-color-light); }
        #export-deck-btn:hover { background-color: var(--accent-color-darker); }
        #delete-deck-btn { background-color: var(--accent-red-darker); color: var(--text-color-light); }
        #delete-deck-btn:hover:not(:disabled) { background-color: #b71c1c; }
        #delete-deck-btn:disabled { background-color: #bdbdbd; cursor: not-allowed; opacity: 0.7; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: center; padding: 20px; box-sizing: border-box;
            z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            background-color: var(--card-background); padding: 25px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 100%; max-width: 400px;
            transform: translateY(-20px); transition: transform 0.3s ease, background-color 0.3s ease; position: relative;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 2em; font-weight: bold; color: #888; cursor: pointer; border: none; background: none; padding: 0; line-height: 1; }
        .modal-close-btn:hover { color: #333; }
        .modal-content h3 { margin-top: 0; color: var(--primary-color); }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-form input { padding: 12px; font-size: 1.1em; border-radius: 8px; border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; }
        .modal-form button { background-color: var(--primary-color); color: var(--text-color-light); }
        .add-word-feedback { color: var(--primary-color); font-weight: bold; height: 1.5em; margin-top: -10px; margin-bottom: 10px; transition: opacity 0.5s; opacity: 0; }
        .add-word-feedback.show { opacity: 1; }
        #confirm-modal-title { color: var(--accent-red-darker); }
        .confirm-modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        #confirm-modal-cancel-btn { background-color: #9e9e9e; color: var(--text-color-light); }
        #confirm-modal-confirm-btn { background-color: var(--accent-red-darker); color: var(--text-color-light); }
        #open-add-word-modal-btn {
            position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background-color: color-mix(in srgb, var(--primary-color) 70%, transparent); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-color-light); border-radius: 50%;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); cursor: pointer; z-index: 10;
            transition: all 0.2s ease-in-out; display: flex; justify-content: center; align-items: center;
            font-size: 2.8em; font-weight: 200;
        }
        #open-add-word-modal-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); background-color: color-mix(in srgb, var(--primary-color) 90%, transparent); }
        #open-add-word-modal-btn:active { transform: translateY(0px) scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        
        #settings-modal h4 { margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color-light); padding-bottom: 5px; color: var(--primary-color-darker); }
        .themes-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .theme-swatch {
            padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;
            transition: all 0.2s ease; text-align: center; position: relative;
        }
        .theme-swatch:hover { transform: translateY(-2px); }
        .theme-swatch.active { border-color: var(--primary-color); box-shadow: 0 0 10px color-mix(in srgb, var(--primary-color) 50%, transparent); }
        .swatch-color { 
            width: 100%; height: 30px; border-radius: 5px; margin-bottom: 5px; 
            border: 1px solid rgba(0,0,0,0.1);
        }
        .swatch-label { font-weight: bold; font-size: 0.9em; }
        .delete-theme-btn {
            position: absolute; top: -5px; right: -5px; background-color: var(--accent-red); color: white;
            border: 1px solid white; border-radius: 50%; width: 20px; height: 20px;
            font-size: 12px; line-height: 18px; text-align: center; cursor: pointer;
            display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .theme-swatch:hover .delete-theme-btn { display: block; }
        .custom-theme-container { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }
        .color-picker-group, .slider-group { display: flex; align-items: center; justify-content: space-between; }
        .color-picker-group label, .slider-group label { font-weight: 500; }
        .color-picker-group input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 50px; height: 30px; border: 1px solid var(--border-color); border-radius: 5px;
            cursor: pointer; background-color: transparent; padding: 0;
        }
        .color-picker-group input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker-group input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
        .slider-group input[type="range"] { flex-grow: 1; margin: 0 10px; }
        .slider-group span { font-weight: bold; min-width: 40px; text-align: right; }
        #remove-bg-image-btn, #save-custom-theme-btn { background-color: var(--accent-orange); color: var(--text-color-light); font-size: 0.9em; padding: 8px 12px; }
        .settings-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        #settings-save-btn { background-color: var(--primary-color); color: var(--text-color-light); }
    </style>
</head>
<body>
    <div class="container">
        <h1>單字卡</h1>
        
        <button id="back-to-menu-btn" class="top-button" title="返回主菜單">&#x2B05;</button>
        <button id="fullscreen-btn" class="top-button" title="切換全螢幕">&#x21F3;</button>

        <div id="main-menu-view" class="view">
            <div id="main-menu-container" class="main-menu-container"></div>
            <div class="mode-selector">
                <label for="mode-toggle">先顯示中文</label>
                <label class="switch">
                    <input type="checkbox" id="mode-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="import-section">
                <label for="file-importer">或從檔案匯入單字包 (可多選 .json):</label>
                <input type="file" id="file-importer" accept=".json" multiple>
                <button id="import-btn">匯入並新增</button> 
            </div>
            <div class="settings-section">
                <button id="open-settings-btn">主題與設定 🎨</button>
            </div>
        </div>

        <div id="flashcard-view" class="view">
             <div class="flashcard-content">
                <div id="mode-display">學習模式</div>
                <div id="flashcard" class="flashcard">
                    <span id="bookmark-icon">&#x1F516;</span>
                    <button id="speak-btn" title="發音">&#x1F50A;</button> 
                    <div id="word-display" class="word"></div>
                    <div id="translation-display" class="translation"></div>
                </div>
                <div class="controls">
                    <button id="mark-unfamiliar-btn">標記為不熟</button>
                </div>
                <p class="instructions" style="font-size:0.9em;color:#888;margin-top:15px;">點擊卡片**左半邊**返回上一張，點擊**右半邊**顯示翻譯或前往下一張。</p>
                <p class="progress">進度：<span id="current-count">0</span> / <span id="total-count">0</span></p>
            </div>
        </div>

        <div id="deck-management-view" class="view">
            <h2 id="deck-manager-title">管理單字包</h2>
            <div class="deck-manager-actions">
                <label>
                    <input type="checkbox" id="select-all-words-checkbox">
                    <span>全選</span>
                </label>
                <button id="multi-delete-btn" disabled>刪除已選 (0)</button>
            </div>
            <div class="word-list-container" id="word-list-container"></div>
            <div class="deck-actions-container">
                <button id="export-deck-btn">匯出此單字卡包</button>
                <button id="delete-deck-btn">刪除此單字卡包</button>
            </div>
            <button id="open-add-word-modal-btn" title="新增單字">+</button>
        </div>
    </div>

    <!-- Add Word Modal -->
    <div id="add-word-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" title="關閉">&times;</button>
            <h3>新增單字</h3>
            <form class="modal-form" id="add-word-form">
                <input type="text" id="new-word-english" placeholder="新英文單字" required>
                <input type="text" id="new-word-chinese" placeholder="新中文翻譯" required>
                <div class="add-word-feedback"></div>
                <button type="submit">新增單字</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Word Modal (NEW) -->
    <div id="edit-word-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" title="關閉">&times;</button>
            <h3>編輯單字</h3>
            <form class="modal-form" id="edit-word-form">
                <input type="text" id="edit-word-english" placeholder="英文單字" required>
                <input type="text" id="edit-word-chinese" placeholder="中文翻譯" required>
                <button type="submit">儲存變更</button>
            </form>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" title="關閉">&times;</button>
            <h3 id="confirm-modal-title">請確認</h3>
            <p id="confirm-modal-text" style="margin: 20px 0; font-size: 1.1em; word-wrap: break-word;"></p>
            <div class="confirm-modal-actions">
                 <button id="confirm-modal-cancel-btn">取消</button>
                 <button id="confirm-modal-confirm-btn">確認</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" title="關閉">&times;</button>
            <h3>主題設定</h3>
            
            <h4>預設主題</h4>
            <div class="themes-container" id="preset-themes-container"></div>
            
            <h4 id="user-themes-heading" style="display:none;">我的主題</h4>
            <div class="themes-container" id="user-themes-container"></div>

            <h4>自訂主題</h4>
            <div class="custom-theme-container">
                <div class="color-picker-group">
                    <label for="primary-color-picker">主要顏色</label>
                    <input type="color" id="primary-color-picker">
                </div>
                <div class="color-picker-group">
                    <label for="accent-color-picker">點綴顏色</label>
                    <input type="color" id="accent-color-picker">
                </div>
                <div class="color-picker-group">
                    <label for="background-color-picker">背景顏色</label>
                    <input type="color" id="background-color-picker">
                </div>
                <div class="slider-group">
                    <label for="container-opacity-slider">背景不透明度</label>
                    <input type="range" id="container-opacity-slider" min="10" max="100" step="1">
                    <span id="opacity-display">100%</span>
                </div>
                <div class="color-picker-group">
                    <label for="background-image-uploader">上傳背景圖片</label>
                    <input type="file" id="background-image-uploader" accept="image/*" style="max-width: 150px;">
                </div>
                <button id="remove-bg-image-btn">移除背景圖片</button>
                <button id="save-custom-theme-btn">儲存目前主題</button>
            </div>
            
            <div class="settings-actions">
                 <button id="settings-save-btn">套用並儲存</button>
            </div>
        </div>
    </div>


    <script>
        const DEFAULT_DECK_NAME = "自訂單字卡";
        let allWordCategoriesData = {}; 
        let unfamiliarWordsInNormalCycle = []; 
        let currentManagingDeck = null;
        let currentWordsSource = [], shuffledWords = [], currentIndex = 0;
        let currentMode = 'normal', currentCategoryName = '';
        let feedbackTimeout; 
        let currentStudyMode = 'en-first';
        let confirmAction = null;
        let selectedWordsToDelete = new Set();
        
        // --- DOM Elements ---
        const views = { 'main-menu-view': document.getElementById('main-menu-view'), 'flashcard-view': document.getElementById('flashcard-view'), 'deck-management-view': document.getElementById('deck-management-view') };
        const mainMenuContainer = document.getElementById('main-menu-container');
        const backToMenuBtnTop = document.getElementById('back-to-menu-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const importBtn = document.getElementById('import-btn');
        const fileImporter = document.getElementById('file-importer');
        const deckManagerTitle = document.getElementById('deck-manager-title');
        const wordListContainer = document.getElementById('word-list-container');
        const deleteDeckBtn = document.getElementById('delete-deck-btn');
        const flashcard = document.getElementById('flashcard'), wordDisplay = document.getElementById('word-display'), translationDisplay = document.getElementById('translation-display'), currentCountSpan = document.getElementById('current-count'), totalCountSpan = document.getElementById('total-count'), markUnfamiliarBtn = document.getElementById('mark-unfamiliar-btn'), modeDisplay = document.getElementById('mode-display'), bookmarkIcon = document.getElementById('bookmark-icon');
        const openAddWordModalBtn = document.getElementById('open-add-word-modal-btn');
        const exportDeckBtn = document.getElementById('export-deck-btn');
        const modeToggle = document.getElementById('mode-toggle');
        const selectAllCheckbox = document.getElementById('select-all-words-checkbox');
        const multiDeleteBtn = document.getElementById('multi-delete-btn');
        const speakBtn = document.getElementById('speak-btn');

        // Modals
        const addWordModal = document.getElementById('add-word-modal');
        const addWordForm = document.getElementById('add-word-form');
        const newWordEnglishInput = document.getElementById('new-word-english');
        const newWordChineseInput = document.getElementById('new-word-chinese');
        const addWordFeedback = addWordModal.querySelector('.add-word-feedback');
        
        const editWordModal = document.getElementById('edit-word-modal');
        const editWordForm = document.getElementById('edit-word-form');
        const editWordEnglishInput = document.getElementById('edit-word-english');
        const editWordChineseInput = document.getElementById('edit-word-chinese');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');

        // Settings Modal Elements
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const settingsSaveBtn = document.getElementById('settings-save-btn');
        const presetThemesContainer = document.getElementById('preset-themes-container');
        const userThemesContainer = document.getElementById('user-themes-container');
        const userThemesHeading = document.getElementById('user-themes-heading');
        const primaryColorPicker = document.getElementById('primary-color-picker');
        const backgroundColorPicker = document.getElementById('background-color-picker');
        const backgroundImageUploader = document.getElementById('background-image-uploader');
        const removeBgImageBtn = document.getElementById('remove-bg-image-btn');
        const saveCustomThemeBtn = document.getElementById('save-custom-theme-btn');
        const accentColorPicker = document.getElementById('accent-color-picker');
        const containerOpacitySlider = document.getElementById('container-opacity-slider');
        const opacityDisplay = document.getElementById('opacity-display');
        
        let currentThemeSettings = {};
        let themeBeforeEdit = {};

        const PRESET_THEMES = {
            default: { name: '預設綠', primary: '#4CAF50', background: '#f4f7f6', text: '#333333', accent: '#03A9F4', opacity: 95 },
            azureWave: { name: '蔚藍浪潮', primary: '#2962FF', background: 'linear-gradient(to right, #72EDF2, #5151E5)', text: '#FFFFFF', accent: '#FF4081', opacity: 95 },
            emeraldGrove: { name: '翡翠之森', primary: '#26A69A', background: 'linear-gradient(to top, #134E5E, #71B280)', text: '#FFFFFF', accent: '#FFC107', opacity: 95 },
            sakuraTwilight: { name: '櫻花薄暮', primary: '#C2185B', background: 'linear-gradient(to top, #a18cd1, #fbc2eb)', text: '#FFFFFF', accent: '#FFD54F', opacity: 95 },
            midnightNova: { name: '午夜新星', primary: '#00E5FF', background: 'linear-gradient(to bottom, #0d1117, #161b22)', text: '#FFFFFF', accent: '#F50057', opacity: 92 }
        };

        const shuffleArray = (array) => { let t=[...array],c=t.length,r;while(0!==c){r=Math.floor(Math.random()*c);c--;[t[c],t[r]]=[t[r],t[c]]}return t; };
        
        // --- App State Management ---
        function saveAppState() { try { localStorage.setItem('allWordDecks', JSON.stringify(allWordCategoriesData)); } catch (e) { console.error("無法保存單字包列表。", e); } }
        function loadAppState() { let loadedDecks = {}; try { const savedDecks = localStorage.getItem('allWordDecks'); if (savedDecks) { const parsed = JSON.parse(savedDecks); if (typeof parsed === 'object' && parsed !== null) { loadedDecks = parsed; } } } catch (e) { console.error("載入單字包列表失敗，將重置。", e); loadedDecks = {}; } if (!loadedDecks.hasOwnProperty(DEFAULT_DECK_NAME)) { loadedDecks[DEFAULT_DECK_NAME] = []; } allWordCategoriesData = loadedDecks; }
        
        async function loadDefaultDecksFromServer() {
            try {
                const indexResponse = await fetch('./cardholder/index.json');
                if (!indexResponse.ok) { console.log('cardholder/index.json not found, skipping default deck loading.'); return; }
                const deckFilenames = await indexResponse.json();
                const fetchPromises = deckFilenames.map(filename => {
                    const deckName = filename.replace(/\.json$/i, '');
                    if (!allWordCategoriesData.hasOwnProperty(deckName)) { return fetch(`./cardholder/${filename}`).then(res => res.json()); }
                    return Promise.resolve(null);
                });
                const newDecksData = await Promise.all(fetchPromises);
                let decksAdded = false;
                newDecksData.forEach((deckContent, index) => {
                    if (deckContent) {
                        const deckName = deckFilenames[index].replace(/\.json$/i, '');
                        allWordCategoriesData[deckName] = deckContent;
                        decksAdded = true;
                    }
                });
                if (decksAdded) { console.log("Default decks loaded from server."); saveAppState(); }
            } catch (error) { console.error("Error loading default decks from server:", error); }
        }
        
        // --- Theme Management ---
        function applyTheme(theme) {
            const root = document.documentElement;
            const safeTheme = { ...PRESET_THEMES.default, ...theme };

            root.style.setProperty('--primary-color', safeTheme.primary);
            root.style.setProperty('--primary-color-darker', chroma(safeTheme.primary).darken(0.6).hex());
            root.style.setProperty('--accent-color', safeTheme.accent);
            root.style.setProperty('--accent-color-darker', chroma(safeTheme.accent).darken(0.6).hex());
            
            if (safeTheme.background && safeTheme.background.includes('gradient')) {
                root.style.setProperty('--bg-image', safeTheme.background);
                const fallbackColor = safeTheme.background.match(/#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})/g)[0] || '#f4f7f6';
                root.style.setProperty('--background-color', fallbackColor);
            } else {
                 root.style.setProperty('--bg-image', 'none');
                 root.style.setProperty('--background-color', safeTheme.background);
            }

            const isDarkBg = chroma(getComputedStyle(root).getPropertyValue('--background-color')).luminance() < 0.5;
            root.style.setProperty('--text-color', safeTheme.text || (isDarkBg ? '#FFFFFF' : '#333333'));
            root.style.setProperty('--text-color-light', chroma.contrast(safeTheme.accent, isDarkBg ? '#fff' : '#000') < 2.5 ? (isDarkBg ? '#000' : '#fff') : '#fff');
            root.style.setProperty('--card-background', isDarkBg ? chroma(getComputedStyle(root).getPropertyValue('--background-color')).brighten(0.5).hex() : '#fff');
            root.style.setProperty('--container-opacity-percent', `${safeTheme.opacity}%`);
            root.style.setProperty('--text-color-muted', isDarkBg ? '#b0b0b0' : '#6c7a89');
            
            if (safeTheme.backgroundImageDataUrl) {
                root.style.setProperty('--bg-image', `url(${safeTheme.backgroundImageDataUrl})`);
                root.style.setProperty('--bg-blur', '2px');
            } else if (!safeTheme.background.includes('gradient')) {
                root.style.setProperty('--bg-image', 'none');
                root.style.setProperty('--bg-blur', '0px');
            }

            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if(themeColorMeta) themeColorMeta.setAttribute('content', safeTheme.primary);
        }

        function saveCurrentThemeSettings() {
            try {
                localStorage.setItem('flashcardTheme', JSON.stringify(currentThemeSettings));
            } catch (e) {
                console.error("Error saving theme to localStorage", e);
                alert("無法儲存主題，可能是儲存空間已滿。");
            }
        }
        
        function loadAndApplyTheme() {
            let loadedTheme = {};
            try {
                const savedTheme = localStorage.getItem('flashcardTheme');
                if (savedTheme) { loadedTheme = JSON.parse(savedTheme); }
            } catch (e) { console.error("Error loading theme, reverting to default.", e); }
            currentThemeSettings = { ...PRESET_THEMES.default, ...loadedTheme };
            applyTheme(currentThemeSettings);
        }
        
        function openSettingsModal() {
            themeBeforeEdit = JSON.parse(JSON.stringify(currentThemeSettings));
            updateThemeControls(currentThemeSettings);
            generateAllThemesUI();
            settingsModal.classList.add('active');
        }

        function closeSettingsModal(revert = false) {
            if(revert) {
                applyTheme(themeBeforeEdit);
                currentThemeSettings = themeBeforeEdit;
            }
            settingsModal.classList.remove('active');
        }

        function handleSaveTheme() {
            saveCurrentThemeSettings();
            alert("主題已套用並儲存！");
            closeSettingsModal();
        }
        
        function generateThemeSwatch(theme, key, isCustom = false) {
             const swatch = document.createElement('div');
             swatch.className = 'theme-swatch';
             swatch.dataset.themeKey = key;
             
             const colorDiv = document.createElement('div');
             colorDiv.className = 'swatch-color';
             if (theme.background && theme.background.includes('gradient')) {
                 colorDiv.style.background = theme.background;
             } else {
                 colorDiv.style.backgroundColor = theme.background;
             }
             colorDiv.style.border = `3px solid ${theme.accent}`;

             swatch.innerHTML = `<div class="swatch-label">${theme.name}</div>`;
             swatch.prepend(colorDiv);

             swatch.addEventListener('click', () => {
                 currentThemeSettings = { ...theme, isCustom };
                 if (!isCustom) {
                     currentThemeSettings.presetKey = key;
                 }
                 applyTheme(currentThemeSettings);
                 updateThemeControls(currentThemeSettings);
             });
             
             if (isCustom) {
                 swatch.dataset.customThemeName = theme.name;
                 const deleteBtn = document.createElement('span');
                 deleteBtn.className = 'delete-theme-btn';
                 deleteBtn.innerHTML = '&times;';
                 deleteBtn.title = `刪除主題 "${theme.name}"`;
                 deleteBtn.onclick = (e) => {
                     e.stopPropagation();
                     if (confirm(`確定要刪除您儲存的主題 "${theme.name}" 嗎？`)) {
                         deleteCustomTheme(theme.name);
                     }
                 };
                 swatch.appendChild(deleteBtn);
             }
             
             return swatch;
        }

        function generateAllThemesUI() {
            presetThemesContainer.innerHTML = '';
            userThemesContainer.innerHTML = '';
            
            for (const key in PRESET_THEMES) {
                presetThemesContainer.appendChild(generateThemeSwatch(PRESET_THEMES[key], key, false));
            }
            
            const userThemes = getCustomThemes();
            if (userThemes.length > 0) {
                userThemesHeading.style.display = 'block';
                userThemes.forEach(theme => {
                    userThemesContainer.appendChild(generateThemeSwatch(theme, theme.name, true));
                });
            } else {
                userThemesHeading.style.display = 'none';
            }
            updateActiveSwatch();
        }

        function updateActiveSwatch() {
            document.querySelectorAll('.theme-swatch').forEach(swatch => {
                let isActive = false;
                if (currentThemeSettings.isCustom) {
                    isActive = swatch.dataset.customThemeName === currentThemeSettings.name;
                } else {
                    isActive = swatch.dataset.themeKey === currentThemeSettings.presetKey;
                }
                swatch.classList.toggle('active', isActive);
            });
        }

        function updateThemeControls(theme) {
            primaryColorPicker.value = chroma(theme.primary).hex();
            accentColorPicker.value = chroma(theme.accent).hex();
            if (theme.background && !theme.background.includes('gradient')) {
                backgroundColorPicker.value = chroma(theme.background).hex();
            }
            containerOpacitySlider.value = theme.opacity;
            opacityDisplay.textContent = `${theme.opacity}%`;
            backgroundImageUploader.value = '';
            updateActiveSwatch();
        }

        function handleCustomThemeChange() {
             currentThemeSettings = {
                primary: primaryColorPicker.value,
                accent: accentColorPicker.value,
                background: backgroundColorPicker.value,
                opacity: parseInt(containerOpacitySlider.value, 10),
                text: chroma.contrast(primaryColorPicker.value, backgroundColorPicker.value) < 4.5 ? (chroma(backgroundColorPicker.value).luminance() > 0.5 ? '#000000' : '#FFFFFF') : (chroma(backgroundColorPicker.value).luminance() > 0.5 ? '#333333' : '#FAFAFA'),
                backgroundImageDataUrl: currentThemeSettings.backgroundImageDataUrl,
                isCustom: true,
                name: '自訂'
            };
            applyTheme(currentThemeSettings);
            opacityDisplay.textContent = `${currentThemeSettings.opacity}%`;
            document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
        }

        function getCustomThemes() {
            try {
                return JSON.parse(localStorage.getItem('userSavedThemes') || '[]');
            } catch {
                return [];
            }
        }

        function saveCustomThemes(themes) {
            try {
                localStorage.setItem('userSavedThemes', JSON.stringify(themes));
            } catch (e) {
                console.error("Error saving custom themes", e);
            }
        }
        
        function handleSaveCustomTheme() {
            const themeName = prompt("請為您的新主題命名：", "我的主題");
            if (!themeName) return;

            const themes = getCustomThemes();
            const existingThemeIndex = themes.findIndex(t => t.name === themeName);
            
            if (existingThemeIndex > -1) {
                if (!confirm(`已存在名為 "${themeName}" 的主題。您要覆蓋它嗎？`)) {
                    return;
                }
            }

            const newTheme = { ...currentThemeSettings, name: themeName };
            
            if (existingThemeIndex > -1) {
                themes[existingThemeIndex] = newTheme;
            } else {
                themes.push(newTheme);
            }
            
            saveCustomThemes(themes);
            alert(`主題 "${themeName}" 已儲存！`);
            generateAllThemesUI();
            updateThemeControls(newTheme);
        }

        function deleteCustomTheme(themeName) {
            let themes = getCustomThemes();
            themes = themes.filter(t => t.name !== themeName);
            saveCustomThemes(themes);
            generateAllThemesUI();
        }
        
        // --- Progress & Mode Persistence ---
        function saveProgress() { try { localStorage.setItem('unfamiliarWordsList', JSON.stringify(unfamiliarWordsInNormalCycle)); } catch (e) { console.error("無法保存不熟單字列表。", e); } }
        function loadUnfamiliarWords() { try { const s = localStorage.getItem('unfamiliarWordsList'); unfamiliarWordsInNormalCycle = s ? JSON.parse(s) : []; } catch (e) { console.error("載入不熟單字列表失敗。", e); unfamiliarWordsInNormalCycle = []; } }
        function saveStudyMode() { try { localStorage.setItem('studyMode', currentStudyMode); } catch (e) { console.error("無法保存學習模式。", e); } }
        function loadStudyMode() { try { const savedMode = localStorage.getItem('studyMode'); if (savedMode === 'zh-first') { currentStudyMode = 'zh-first'; modeToggle.checked = true; } else { currentStudyMode = 'en-first'; modeToggle.checked = false; } } catch (e) { console.error("載入學習模式失敗。", e); currentStudyMode = 'en-first'; } }
        
        // --- View & UI Management ---
        function showView(viewName) { for (let id in views) { views[id].classList.remove('active'); } views[viewName].classList.add('active'); const showTopButtons = (viewName === 'flashcard-view' || viewName === 'deck-management-view'); backToMenuBtnTop.style.display = showTopButtons ? 'flex' : 'none'; fullscreenBtn.style.display = showTopButtons ? 'flex' : 'none'; if (viewName === 'main-menu-view') renderMainMenu(); }
        function renderMainMenu() { mainMenuContainer.innerHTML = ''; const createCategoryButton = (categoryName, specialClass = '') => { const item = document.createElement('div'); item.className = `category-item ${specialClass}`; item.innerHTML = `<span>${categoryName}</span><span class="manage-deck-btn" title="管理 '${categoryName}'">⚙️</span>`; item.querySelector('.manage-deck-btn').addEventListener('click', e => { e.stopPropagation(); openDeckManager(categoryName); }); item.addEventListener('click', () => startCategoryLearning(categoryName)); mainMenuContainer.appendChild(item); }; const customDeckNames = Object.keys(allWordCategoriesData).filter(name => name !== DEFAULT_DECK_NAME).sort(); customDeckNames.forEach(name => createCategoryButton(name)); if (allWordCategoriesData.hasOwnProperty(DEFAULT_DECK_NAME)) { createCategoryButton(DEFAULT_DECK_NAME, 'default-category'); } const unfamiliarItem = document.createElement('div'); unfamiliarItem.className = 'category-item unfamiliar-category'; unfamiliarItem.innerHTML = `<span>不熟單字</span> <span class="unfamiliar-count">${unfamiliarWordsInNormalCycle.length}</span>`; unfamiliarItem.addEventListener('click', startUnfamiliarReviewMode); mainMenuContainer.appendChild(unfamiliarItem); }
        
        // --- Modal Handling ---
        function openAddWordModal() { addWordModal.classList.add('active'); setTimeout(() => newWordEnglishInput.focus(), 50); }
        function closeAddWordModal() { addWordForm.reset(); addWordFeedback.classList.remove('show'); clearTimeout(feedbackTimeout); addWordModal.classList.remove('active'); }
        function openEditWordModal(originalWord) {
            editWordModal.dataset.originalEnglish = originalWord.english;
            editWordEnglishInput.value = originalWord.english;
            editWordChineseInput.value = originalWord.chinese;
            editWordModal.classList.add('active');
            setTimeout(() => editWordEnglishInput.focus(), 50);
        }
        function closeEditWordModal() {
            editWordForm.reset();
            delete editWordModal.dataset.originalEnglish;
            editWordModal.classList.remove('active');
        }
        function showConfirmModal(title, text, onConfirm) { confirmModalTitle.textContent = title; confirmModalText.innerHTML = text; confirmAction = onConfirm; confirmModal.classList.add('active'); }
        function closeConfirmModal() { confirmModal.classList.remove('active'); confirmAction = null; }

        // --- Deck Management ---
        function openDeckManager(categoryName) { currentManagingDeck = categoryName; deckManagerTitle.textContent = `管理: ${categoryName}`; deleteDeckBtn.disabled = (categoryName === DEFAULT_DECK_NAME); deleteDeckBtn.title = (categoryName === DEFAULT_DECK_NAME) ? "預設單字包無法刪除" : ""; renderWordList(categoryName); showView('deck-management-view'); }
        function renderWordList(categoryName) {
            wordListContainer.innerHTML = ''; selectedWordsToDelete.clear();
            const words = allWordCategoriesData[categoryName] || [];
            if (words.length === 0) { wordListContainer.innerHTML = '<p style="color: #888; padding: 20px 0; text-align: center;">這個單字包是空的。點擊右下角 + 來新增！</p>'; } else {
                words.forEach(word => {
                    const item = document.createElement('div');
                    item.className = 'word-list-item';
                    item.dataset.originalEnglish = word.english;
                    item.innerHTML = `
                        <input type="checkbox" class="word-select-checkbox" data-english="${word.english}">
                        <div class="word-content-wrapper" title="點擊以編輯">
                            <span><strong>${word.english}</strong>: ${word.chinese}</span>
                        </div>`;
                    wordListContainer.appendChild(item);
                });
            }
            updateMultiDeleteUI(); selectAllCheckbox.checked = false;
        }

        function handleWordSelectionChange(event) {
            const checkbox = event.target; const wordEng = checkbox.dataset.english;
            if (checkbox.checked) { selectedWordsToDelete.add(wordEng); } else { selectedWordsToDelete.delete(wordEng); }
            const allWordCheckboxes = wordListContainer.querySelectorAll('.word-select-checkbox');
            selectAllCheckbox.checked = allWordCheckboxes.length > 0 && selectedWordsToDelete.size === allWordCheckboxes.length;
            updateMultiDeleteUI();
        }
        function updateMultiDeleteUI() {
            const count = selectedWordsToDelete.size;
            multiDeleteBtn.disabled = count === 0;
            multiDeleteBtn.textContent = `刪除已選 (${count})`;
        }
        function handleDeleteDeck() { if (!currentManagingDeck || currentManagingDeck === DEFAULT_DECK_NAME) return; showConfirmModal('確認刪除單字包', `您確定要永久刪除「<strong>${currentManagingDeck}</strong>」這個單字卡包嗎？<br>此操作無法復原！`, () => { delete allWordCategoriesData[currentManagingDeck]; saveAppState(); alert(`單字卡包「${currentManagingDeck}」已刪除。`); backToMainMenu(); }); }
        function handleMultiDelete() {
            const count = selectedWordsToDelete.size; if (count === 0 || !currentManagingDeck) return;
            showConfirmModal('確認刪除單字', `確定要從 "${currentManagingDeck}" 中永久刪除這 <strong>${count}</strong> 個單字嗎？`, () => { allWordCategoriesData[currentManagingDeck] = allWordCategoriesData[currentManagingDeck].filter(word => !selectedWordsToDelete.has(word.english)); saveAppState(); renderWordList(currentManagingDeck); });
        }
        function handleAddWord(event) { event.preventDefault(); const newEng = newWordEnglishInput.value.trim(); const newChi = newWordChineseInput.value.trim(); if (!newEng || !newChi || !currentManagingDeck) return alert('英文和中文欄位都不能為空！'); if (allWordCategoriesData[currentManagingDeck].some(w => w.english.toLowerCase() === newEng.toLowerCase())) return alert(`單字 "${newEng}" 已存在！`); allWordCategoriesData[currentManagingDeck].push({ english: newEng, chinese: newChi }); saveAppState(); renderWordList(currentManagingDeck); addWordFeedback.textContent = '新增成功！'; addWordFeedback.classList.add('show'); clearTimeout(feedbackTimeout); feedbackTimeout = setTimeout(() => { addWordFeedback.classList.remove('show'); }, 2000); addWordForm.reset(); newWordEnglishInput.focus(); }
        function handleEditWord(event) {
            event.preventDefault();
            const originalEng = editWordModal.dataset.originalEnglish;
            const newEng = editWordEnglishInput.value.trim();
            const newChi = editWordChineseInput.value.trim();
            if (!newEng || !newChi) { return alert('英文和中文欄位都不能為空！'); }

            const wordExists = allWordCategoriesData[currentManagingDeck].some(w => w.english.toLowerCase() === newEng.toLowerCase() && w.english.toLowerCase() !== originalEng.toLowerCase());
            if (wordExists) { return alert(`單字 "${newEng}" 已存在於此單字包中！`); }
            
            const wordIndex = allWordCategoriesData[currentManagingDeck].findIndex(w => w.english === originalEng);
            if (wordIndex > -1) {
                allWordCategoriesData[currentManagingDeck][wordIndex] = { english: newEng, chinese: newChi };
                saveAppState();
                renderWordList(currentManagingDeck);
                closeEditWordModal();
            } else {
                alert('發生錯誤：找不到原始單字。');
            }
        }
        function handleExportDeck() { if (!currentManagingDeck) return; const deckName = currentManagingDeck; const wordsToExport = allWordCategoriesData[deckName] || []; if (wordsToExport.length === 0) { alert(`「${deckName}」是空的，沒有可匯出的單字。`); return; } const jsonString = JSON.stringify(wordsToExport, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${deckName}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        function handleFileImport() { if (fileImporter.files.length === 0) return alert('請先選擇一個或多個 .json 檔案！'); for (const file of fileImporter.files) { const reader = new FileReader(); reader.onload = (event) => { try { const newWords = JSON.parse(event.target.result); if (!Array.isArray(newWords) || (newWords.length > 0 && (!newWords[0].english || !newWords[0].chinese))) throw new Error(`檔案 "${file.name}" 格式不正確。`); const categoryName = file.name.replace(/\.json$/i, ''); if (categoryName === DEFAULT_DECK_NAME) { if (!confirm(`您正試圖用檔案 "${file.name}" 覆蓋預設單字包 "${DEFAULT_DECK_NAME}"。\n確定要繼續嗎？`)) return; } else if (allWordCategoriesData[categoryName] && !confirm(`分類 "${categoryName}" 已存在。是否要用檔案 "${file.name}" 的內容覆蓋它？`)) return; allWordCategoriesData[categoryName] = newWords; saveAppState(); renderMainMenu(); alert(`分類 "${categoryName}" 已成功從檔案 "${file.name}" 匯入/更新！`); } catch (e) { alert(`匯入檔案 "${file.name}" 失敗: ` + e.message); } }; reader.onerror = () => alert(`讀取檔案 "${file.name}" 時發生錯誤。`); reader.readAsText(file); } fileImporter.value = ''; }
        
        // --- Flashcard Learning Logic ---
        function filterAndPrepareWords(wordList) { if (!wordList) return []; const flatList = Object.values(allWordCategoriesData).flat(); return wordList.filter(w => flatList.some(ow => ow.english === w.english && ow.chinese === w.chinese)).map(w => ({...w, revealed: w.revealed || false})); };
        function startCategoryLearning(categoryName) { currentCategoryName = categoryName; currentWordsSource = allWordCategoriesData[categoryName]; if (!currentWordsSource || currentWordsSource.length === 0) { alert(`"${categoryName}" 類別目前沒有單字！\n請點擊右方的 ⚙️ 圖示來新增或管理單字。`); return; } currentMode = 'normal'; shuffledWords = shuffleArray(currentWordsSource.map(w => ({ ...w, revealed: false }))); currentIndex = 0; displayCard(); showView('flashcard-view'); }
        function startUnfamiliarReviewMode() { const validUnfamiliarWords = filterAndPrepareWords(unfamiliarWordsInNormalCycle); if (validUnfamiliarWords.length !== unfamiliarWordsInNormalCycle.length) { unfamiliarWordsInNormalCycle = validUnfamiliarWords; saveProgress(); } if (unfamiliarWordsInNormalCycle.length === 0) { alert('目前沒有不熟的單字可以複習！'); return; } currentCategoryName = '不熟單字'; currentMode = 'review'; shuffledWords = shuffleArray(unfamiliarWordsInNormalCycle.map(w => ({ ...w, revealed: false }))); currentIndex = 0; displayCard(); showView('flashcard-view'); }
        
        function handleSpeakWord(event) {
            event.stopPropagation();
            if (shuffledWords.length === 0) return;
            const wordToSpeak = shuffledWords[currentIndex].english;
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // UPGRADE: Stop any ongoing speech.
                const utterance = new SpeechSynthesisUtterance(wordToSpeak);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                alert('您的瀏覽器不支援語音合成功能。');
            }
        }
        
        function displayCard() {
            if (shuffledWords.length === 0) { wordDisplay.textContent = "此類別沒有單字。"; translationDisplay.textContent = ""; translationDisplay.style.display = 'none'; currentCountSpan.textContent = 0; totalCountSpan.textContent = 0; markUnfamiliarBtn.style.display = 'none'; modeDisplay.textContent = "完成！"; flashcard.classList.remove('revealed-background'); bookmarkIcon.style.display = 'none'; speakBtn.style.display = 'none'; return; }
            speakBtn.style.display = 'block'; const currentWord = shuffledWords[currentIndex]; let frontText, backText;
            if (currentStudyMode === 'zh-first') { frontText = currentWord.chinese; backText = currentWord.english; } else { frontText = currentWord.english; backText = currentWord.chinese; }
            wordDisplay.textContent = frontText; translationDisplay.textContent = backText;
            if (currentWord.revealed) { translationDisplay.style.display = 'block'; flashcard.classList.add('revealed-background'); } else { translationDisplay.style.display = 'none'; flashcard.classList.remove('revealed-background'); }
            const isBookmarked = unfamiliarWordsInNormalCycle.some(w => w.english === currentWord.english); bookmarkIcon.style.display = isBookmarked ? 'block' : 'none';
            updateProgress(); markUnfamiliarBtn.style.display = 'block'; updateButtonText();
            modeDisplay.textContent = currentMode === 'normal' ? `學習模式: ${currentCategoryName}` : '複習模式: 不熟單字';
        }
        function handleCardClick(event) { if (shuffledWords.length === 0) return; const cardWidth = flashcard.offsetWidth; const clickX = event.clientX - flashcard.getBoundingClientRect().left; const currentWordObj = shuffledWords[currentIndex]; if (clickX < cardWidth / 2) { showPreviousWord(); } else { if (!currentWordObj.revealed) { translationDisplay.style.display = 'block'; flashcard.classList.add('revealed-background'); currentWordObj.revealed = true; } else { showNextWord(); } } }
        function showPreviousWord() { if (shuffledWords.length > 0 && currentIndex > 0) { currentIndex--; displayCard(); } }
        function showNextWord() { if (shuffledWords.length > 0) { currentIndex++; if (currentIndex >= shuffledWords.length) handleCycleEnd(); else displayCard(); } }
        function handleCycleEnd() { if (currentMode === 'normal') { if (unfamiliarWordsInNormalCycle.length > 0 && confirm(`"${currentCategoryName}"單字已看過一次！是否要跳到複習不熟的單字？`)) { startUnfamiliarReviewMode(); } else { alert(`"${currentCategoryName}"單字已看過一次！即將重新開始。`); startCategoryLearning(currentCategoryName); } } else { if (confirm('不熟單字已複習完畢！是否要再次複習這些單字？')) { startUnfamiliarReviewMode(); } else { alert('即將返回主菜單。'); showView('main-menu-view'); } } }
        function handleUnfamiliarAction() { if (shuffledWords.length === 0) return; const currentWord = shuffledWords[currentIndex]; const isBookmarked = unfamiliarWordsInNormalCycle.some(word => word.english === currentWord.english); if (currentMode === 'normal') { if (!isBookmarked) { unfamiliarWordsInNormalCycle.push({ ...currentWord, revealed: false }); } else { unfamiliarWordsInNormalCycle = unfamiliarWordsInNormalCycle.filter(word => word.english !== currentWord.english); } } else { unfamiliarWordsInNormalCycle = unfamiliarWordsInNormalCycle.filter(word => word.english !== currentWord.english); shuffledWords.splice(currentIndex, 1); if (shuffledWords.length === 0) { currentIndex = 0; handleCycleEnd(); return; } else if (currentIndex >= shuffledWords.length) { currentIndex = shuffledWords.length - 1; } } saveProgress(); renderMainMenu(); displayCard(); }
        function updateButtonText() { if (shuffledWords.length === 0) return; const isBookmarked = unfamiliarWordsInNormalCycle.some(w => w.english === shuffledWords[currentIndex].english); if (currentMode === 'normal') { markUnfamiliarBtn.classList.remove('delete-mode'); markUnfamiliarBtn.textContent = isBookmarked ? '取消標記不熟' : '標記為不熟'; markUnfamiliarBtn.classList.toggle('unmark-mode', isBookmarked); } else { markUnfamiliarBtn.textContent = '刪除不熟'; markUnfamiliarBtn.classList.add('delete-mode'); markUnfamiliarBtn.classList.remove('unmark-mode'); } }
        function updateProgress() { currentCountSpan.textContent = shuffledWords.length > 0 ? currentIndex + 1 : 0; totalCountSpan.textContent = shuffledWords.length; }
        function backToMainMenu() { currentManagingDeck = null; showView('main-menu-view'); }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => alert(`無法進入全螢幕模式: ${err.message}`)); else document.exitFullscreen(); }
        
        async function init() {
            const chromaScript = document.createElement('script');
            chromaScript.src = "https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js";
            chromaScript.onload = async () => {
                if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err)); }); }

                loadAndApplyTheme(); 
                loadAppState(); 
                await loadDefaultDecksFromServer();
                loadUnfamiliarWords();
                loadStudyMode();
                showView('main-menu-view');
                
                // --- Event Listeners ---
                backToMenuBtnTop.addEventListener('click', backToMainMenu);
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                importBtn.addEventListener('click', handleFileImport);
                deleteDeckBtn.addEventListener('click', handleDeleteDeck);
                exportDeckBtn.addEventListener('click', handleExportDeck);
                flashcard.addEventListener('click', handleCardClick);
                speakBtn.addEventListener('click', handleSpeakWord);
                markUnfamiliarBtn.addEventListener('click', handleUnfamiliarAction);
                
                // Modals
                openAddWordModalBtn.addEventListener('click', openAddWordModal);
                addWordForm.addEventListener('submit', handleAddWord);
                addWordModal.querySelector('.modal-close-btn').addEventListener('click', closeAddWordModal);
                addWordModal.addEventListener('click', (e) => { if (e.target === addWordModal) closeAddWordModal(); });
                
                editWordForm.addEventListener('submit', handleEditWord);
                editWordModal.querySelector('.modal-close-btn').addEventListener('click', closeEditWordModal);
                editWordModal.addEventListener('click', (e) => { if (e.target === editWordModal) closeEditWordModal(); });

                confirmModalConfirmBtn.addEventListener('click', () => { if (typeof confirmAction === 'function') confirmAction(); closeConfirmModal(); });
                confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
                confirmModal.querySelector('.modal-close-btn').addEventListener('click', closeConfirmModal);
                confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) closeConfirmModal(); });
                
                // Deck Manager
                multiDeleteBtn.addEventListener('click', handleMultiDelete);
                selectAllCheckbox.addEventListener('change', (e) => {
                    wordListContainer.querySelectorAll('.word-select-checkbox').forEach(checkbox => {
                        if (checkbox.checked !== e.target.checked) {
                            checkbox.checked = e.target.checked;
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                });
                wordListContainer.addEventListener('click', (e) => {
                    const item = e.target.closest('.word-list-item');
                    if (!item) return;
                    // Clicking the checkbox itself is handled by its own change listener
                    if (e.target.classList.contains('word-select-checkbox')) return;

                    const originalEng = item.dataset.originalEnglish;
                    const word = allWordCategoriesData[currentManagingDeck].find(w => w.english === originalEng);
                    if (word) {
                        openEditWordModal(word);
                    }
                });
                wordListContainer.addEventListener('change', (e) => { if (e.target.classList.contains('word-select-checkbox')) handleWordSelectionChange(e); });

                // Settings Modal
                openSettingsBtn.addEventListener('click', openSettingsModal);
                settingsModal.querySelector('.modal-close-btn').addEventListener('click', () => closeSettingsModal(true));
                settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(true); });
                settingsSaveBtn.addEventListener('click', handleSaveTheme);
                saveCustomThemeBtn.addEventListener('click', handleSaveCustomTheme);
                primaryColorPicker.addEventListener('input', handleCustomThemeChange);
                accentColorPicker.addEventListener('input', handleCustomThemeChange);
                backgroundColorPicker.addEventListener('input', handleCustomThemeChange);
                containerOpacitySlider.addEventListener('input', handleCustomThemeChange);
                
                backgroundImageUploader.addEventListener('change', () => {
                    if (backgroundImageUploader.files && backgroundImageUploader.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            currentThemeSettings.backgroundImageDataUrl = e.target.result;
                            handleCustomThemeChange();
                        };
                        reader.readAsDataURL(backgroundImageUploader.files[0]);
                    }
                });
                removeBgImageBtn.addEventListener('click', () => {
                    currentThemeSettings.backgroundImageDataUrl = null;
                    backgroundImageUploader.value = '';
                    handleCustomThemeChange();
                });
                
                modeToggle.addEventListener('change', () => { currentStudyMode = modeToggle.checked ? 'zh-first' : 'en-first'; saveStudyMode(); });
                setInterval(saveProgress, 10000); 
            };
            document.head.appendChild(chromaScript);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>