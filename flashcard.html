<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的單字卡 (體驗完善版)</title>
    
    <!-- PWA Modifications START -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <!-- PWA Modifications END -->

    <style>
        /* CSS is completely unchanged from the previous version. */
        html, body {
            height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; justify-content: center; align-items: center; background-color: #f4f7f6; color: #333;
        }
        .container {
            text-align: center; background-color: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 500px; width: 100%; height: 100vh; max-height: 800px; box-sizing: border-box; padding: 20px;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        h1 { color: #4CAF50; margin-top: 0; margin-bottom: 20px; font-size: 2.5em; flex-shrink: 0; }
        .view {
            display: none; width: 100%; flex-grow: 1; overflow-y: auto; box-sizing: border-box;
            padding-bottom: 20px; flex-direction: column; align-items: center; position: relative;
        }
        .view.active { display: flex; }

        .main-menu-container {
            border: 2px solid #ccc; border-radius: 10px; padding: 20px; background-color: #f9f9f9;
            width: 100%; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; align-items: stretch;
        }
        .mode-selector {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin-top: 20px;
            background-color: #e8f5e9;
            border: 2px solid #a5d6a7;
            border-radius: 10px;
            box-sizing: border-box;
        }
        .mode-selector label { font-size: 1.1em; font-weight: bold; color: #2e7d32; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #4CAF50; }
        input:focus + .slider { box-shadow: 0 0 1px #4CAF50; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        .import-section {
            margin-top: 20px; padding: 15px; border: 2px dashed #03a9f4; border-radius: 10px;
            background-color: #e3f2fd; display: flex; flex-direction: column; gap: 10px; align-items: stretch;
        }
        .import-section label { font-weight: bold; color: #0277bd; }
        .import-section input[type="file"] { border: 1px solid #ccc; padding: 8px; border-radius: 5px; background-color: white; }
        .import-section button { background-color: #2196F3; color: white; }
        .category-item {
            padding: 15px 20px; font-size: 1.2em; border: none; border-radius: 8px; cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); font-weight: bold; color: white;
            background-color: #03a9f4; text-align: left; display: flex; flex-direction: row;
            justify-content: space-between; align-items: center;
        }
        .category-item:hover { transform: translateY(-2px); }
        .category-item.unfamiliar-category { background-color: #f44336; }
        .category-item.default-category { background-color: #78909c; }
        .category-item.default-category:hover { background-color: #546e7a; }
        .unfamiliar-count, .manage-deck-btn {
            background-color: rgba(255, 255, 255, 0.3); border-radius: 5px;
            padding: 5px 10px; font-size: 0.9em; margin-left: 10px;
        }
        .manage-deck-btn { cursor: pointer; transition: background-color 0.2s; font-size: 1.1em; }
        .manage-deck-btn:hover { background-color: rgba(0, 0, 0, 0.2); }

        .flashcard-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; width: 100%; padding-top: 10px; box-sizing: border-box; }
        .flashcard { background-color: #e0f2f7; border: 2px solid #a7d9eb; border-radius: 10px; width: min(80vw, 350px); height: min(80vw, 350px); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; box-sizing: border-box; overflow: hidden; text-align: center; flex-shrink: 0; position: relative; }
        .flashcard.revealed-background { background-color: #ffe0b2; }
        .word { font-size: 2.2em; font-weight: bold; color: #2c3e50; margin-bottom: 15px; word-wrap: break-word; padding: 0 10px; }
        .translation { font-size: 1.5em; color: #6c7a89; font-weight: 500; word-wrap: break-word; display: none; padding: 0 10px; }
        .progress { font-size: 1em; color: #555; margin-top: 10px; }
        .progress span { font-weight: bold; color: #4CAF50; }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 300px; flex-shrink: 0; }
        button { padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); font-weight: bold; }
        button:disabled { background-color: #bdbdbd; cursor: not-allowed; opacity: 0.7; }
        button:disabled:hover { background-color: #bdbdbd; }
        #mark-unfamiliar-btn { background-color: #ff9800; color: white; }
        #mark-unfamiliar-btn.unmark-mode { background-color: #ffc107; }
        #mark-unfamiliar-btn.delete-mode { background-color: #f44336; }
        .top-button { position: absolute; top: 20px; z-index: 20; background-color: rgba(0, 0, 0, 0.3); color: white; padding: 8px; font-size: 1.8em; border-radius: 5px; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); line-height: 1; cursor: pointer; border: none; flex-shrink: 0; }
        #back-to-menu-btn { left: 20px; }
        #fullscreen-btn { right: 20px; }
        #bookmark-icon { position: absolute; top: 10px; right: 10px; font-size: 1.5em; color: #e0b445; display: none; z-index: 5; }
        #speak-btn {
            position: absolute; bottom: 10px; right: 10px; font-size: 1.8em; color: #3d5afe;
            cursor: pointer; z-index: 5; border: none; background: none; padding: 5px;
            transition: color 0.2s, transform 0.2s; display: none;
        }
        #speak-btn:hover { color: #002ab0; transform: scale(1.1); }


        #deck-management-view { gap: 15px; justify-content: flex-start; align-items: stretch; }
        #deck-manager-title { color: #0277bd; margin: 0 0 10px 0; flex-shrink: 0; text-align: center; }
        .deck-manager-actions {
            display: flex; justify-content: space-between; align-items: center; padding: 10px;
            border-bottom: 2px solid #ddd; background-color: #f5f5f5; flex-shrink: 0;
        }
        .deck-manager-actions label { display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer; }
        .deck-manager-actions input[type="checkbox"] { transform: scale(1.4); cursor: pointer; }
        #multi-delete-btn { background-color: #f44336; color: white; padding: 8px 15px; font-size: 1em; }
        #multi-delete-btn:hover:not(:disabled) { background-color: #d32f2f; }

        .word-list-container {
            width: 100%; flex-grow: 1; overflow-y: auto;
            border: 1px solid #ddd; border-radius: 8px; padding: 10px;
            background-color: #fafafa; padding-bottom: 80px; box-sizing: border-box;
        }
        .word-list-item { display: flex; justify-content: flex-start; align-items: center; padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 1.1em; gap: 15px; }
        .word-list-item:last-child { border-bottom: none; }
        .word-list-item .word-select-checkbox { transform: scale(1.5); flex-shrink: 0; cursor: pointer; }

        .word-content-wrapper { flex-grow: 1; text-align: left; }
        .word-display-container { cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s; }
        .word-display-container:hover { background-color: #e0f7fa; }
        .word-list-item.editing .word-display-container { display: none; }
        .word-edit-container { display: none; align-items: center; gap: 8px; }
        .word-list-item.editing .word-edit-container { display: flex; }
        .word-edit-container input {
            flex-grow: 1; padding: 8px; font-size: 1em; border: 1px solid #03a9f4;
            border-radius: 5px; outline: none;
        }
        .word-edit-container input:focus { box-shadow: 0 0 0 2px rgba(3, 169, 244, 0.4); }
        .word-edit-container button {
            padding: 8px 10px; font-size: 1.1em; flex-shrink: 0; line-height: 1;
            min-width: 40px;
        }
        .save-edit-btn { background-color: #4CAF50; color: white; }
        .cancel-edit-btn { background-color: #f44336; color: white; }

        .deck-actions-container { margin-top: auto; display: flex; flex-direction: column; gap: 10px; }
        #export-deck-btn { background-color: #2196F3; color: white; }
        #export-deck-btn:hover { background-color: #1976D2; }
        #delete-deck-btn { background-color: #c62828; color: white; }
        #delete-deck-btn:hover:not(:disabled) { background-color: #b71c1c; }
        #delete-deck-btn:disabled { background-color: #bdbdbd; cursor: not-allowed; opacity: 0.7; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
            align-items: flex-start; padding-top: 10vh; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 90%; max-width: 400px;
            transform: translateY(-20px); transition: transform 0.3s ease; position: relative;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 2em; font-weight: bold; color: #888; cursor: pointer; border: none; background: none; padding: 0; line-height: 1; }
        .modal-close-btn:hover { color: #333; }
        .modal-content h3 { margin-top: 0; color: #4CAF50; }
        .add-word-form-modal { display: flex; flex-direction: column; gap: 15px; }
        .add-word-form-modal input { padding: 12px; font-size: 1.1em; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        .add-word-form-modal button { background-color: #4CAF50; color: white; }
        .add-word-feedback { color: #4CAF50; font-weight: bold; height: 1.5em; margin-top: -10px; margin-bottom: 10px; transition: opacity 0.5s; opacity: 0; }
        .add-word-feedback.show { opacity: 1; }
        #confirm-modal-title { color: #c62828; }
        .confirm-modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        #confirm-modal-cancel-btn { background-color: #9e9e9e; color: white; }
        #confirm-modal-confirm-btn { background-color: #c62828; color: white; }


        #open-add-word-modal-btn {
            position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background-color: rgba(76, 175, 80, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 50%;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); cursor: pointer; z-index: 10;
            transition: all 0.2s ease-in-out; display: flex; justify-content: center; align-items: center;
            font-size: 2.8em; font-weight: 200;
        }
        #open-add-word-modal-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); background-color: rgba(76, 175, 80, 0.9); }
        #open-add-word-modal-btn:active { transform: translateY(0px) scale(1); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
    </style>
</head>
<body>
    <div class="container">
        <h1>單字卡</h1>
        
        <button id="back-to-menu-btn" class="top-button" title="返回主菜單">&#x2B05;</button>
        <button id="fullscreen-btn" class="top-button" title="切換全螢幕">&#x21F3;</button>

        <!-- Views -->
        <div id="main-menu-view" class="view">
            <div id="main-menu-container" class="main-menu-container"></div>
            <div class="mode-selector">
                <label for="mode-toggle">先顯示中文</label>
                <label class="switch">
                    <input type="checkbox" id="mode-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="import-section">
                <label for="file-importer">或從檔案匯入單字包 (可多選 .json):</label>
                <input type="file" id="file-importer" accept=".json" multiple>
                <button id="import-btn">匯入並新增</button> 
            </div>
        </div>

        <div id="flashcard-view" class="view">
             <div class="flashcard-content">
                <div id="mode-display">學習模式</div>
                <div id="flashcard" class="flashcard">
                    <span id="bookmark-icon">&#x1F516;</span>
                    <button id="speak-btn" title="發音">&#x1F50A;</button> 
                    <div id="word-display" class="word"></div>
                    <div id="translation-display" class="translation"></div>
                </div>
                <div class="controls">
                    <button id="mark-unfamiliar-btn">標記為不熟</button>
                </div>
                <p class="instructions" style="font-size:0.9em;color:#888;margin-top:15px;">點擊卡片**左半邊**返回上一張，點擊**右半邊**顯示翻譯或前往下一張。</p>
                <p class="progress">進度：<span id="current-count">0</span> / <span id="total-count">0</span></p>
            </div>
        </div>

        <div id="deck-management-view" class="view">
            <h2 id="deck-manager-title">管理單字包</h2>
            <div class="deck-manager-actions">
                <label>
                    <input type="checkbox" id="select-all-words-checkbox">
                    <span>全選</span>
                </label>
                <button id="multi-delete-btn" disabled>刪除已選 (0)</button>
            </div>
            <div class="word-list-container" id="word-list-container"></div>
            <div class="deck-actions-container">
                <button id="export-deck-btn">匯出此單字卡包</button>
                <button id="delete-deck-btn">刪除此單字卡包</button>
            </div>
            <button id="open-add-word-modal-btn" title="新增單字">+</button>
        </div>
    </div>

    <div id="add-word-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" title="關閉">&times;</button>
            <h3>新增單字</h3>
            <form class="add-word-form-modal" id="add-word-form">
                <input type="text" id="new-word-english" placeholder="新英文單字" required>
                <input type="text" id="new-word-chinese" placeholder="新中文翻譯" required>
                <div class="add-word-feedback"></div>
                <button type="submit">新增單字</button>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" title="關閉">&times;</button>
            <h3 id="confirm-modal-title">請確認</h3>
            <p id="confirm-modal-text" style="margin: 20px 0; font-size: 1.1em; word-wrap: break-word;"></p>
            <div class="confirm-modal-actions">
                 <button id="confirm-modal-cancel-btn">取消</button>
                 <button id="confirm-modal-confirm-btn">確認</button>
            </div>
        </div>
    </div>


    <script>
        // All Javascript code is the same as the previous version...
        // with the addition of the Service Worker registration code.
        const DEFAULT_DECK_NAME = "自訂單字卡";
        let allWordCategoriesData = {}; 
        let allOriginalWordsFlat = []; 
        let unfamiliarWordsInNormalCycle = []; 
        let currentManagingDeck = null;
        let currentWordsSource = [], shuffledWords = [], currentIndex = 0;
        let currentMode = 'normal', currentCategoryName = '';
        let feedbackTimeout; 
        let currentStudyMode = 'en-first';
        let confirmAction = null;
        let selectedWordsToDelete = new Set();
        let currentlyEditingElement = null;


        const views = { 'main-menu-view': document.getElementById('main-menu-view'), 'flashcard-view': document.getElementById('flashcard-view'), 'deck-management-view': document.getElementById('deck-management-view') };
        const mainMenuContainer = document.getElementById('main-menu-container');
        const backToMenuBtnTop = document.getElementById('back-to-menu-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const importBtn = document.getElementById('import-btn');
        const fileImporter = document.getElementById('file-importer');
        const deckManagerTitle = document.getElementById('deck-manager-title');
        const wordListContainer = document.getElementById('word-list-container');
        const deleteDeckBtn = document.getElementById('delete-deck-btn');
        const flashcard = document.getElementById('flashcard'), wordDisplay = document.getElementById('word-display'), translationDisplay = document.getElementById('translation-display'), currentCountSpan = document.getElementById('current-count'), totalCountSpan = document.getElementById('total-count'), markUnfamiliarBtn = document.getElementById('mark-unfamiliar-btn'), modeDisplay = document.getElementById('mode-display'), bookmarkIcon = document.getElementById('bookmark-icon');
        const addWordModal = document.getElementById('add-word-modal');
        const openAddWordModalBtn = document.getElementById('open-add-word-modal-btn');
        const addWordForm = document.getElementById('add-word-form');
        const newWordEnglishInput = document.getElementById('new-word-english');
        const newWordChineseInput = document.getElementById('new-word-chinese');
        const addWordFeedback = addWordModal.querySelector('.add-word-feedback');
        const exportDeckBtn = document.getElementById('export-deck-btn');
        const modeToggle = document.getElementById('mode-toggle');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const selectAllCheckbox = document.getElementById('select-all-words-checkbox');
        const multiDeleteBtn = document.getElementById('multi-delete-btn');
        const speakBtn = document.getElementById('speak-btn');


        const shuffleArray = (array) => { let t=[...array],c=t.length,r;while(0!==c){r=Math.floor(Math.random()*c);c--;[t[c],t[r]]=[t[r],t[c]]}return t; };
        function saveAppState() { try { localStorage.setItem('allWordDecks', JSON.stringify(allWordCategoriesData)); allOriginalWordsFlat = Object.values(allWordCategoriesData).flat(); } catch (e) { console.error("無法保存單字包列表。", e); } }
        function loadAppState() { let loadedDecks = {}; try { const savedDecks = localStorage.getItem('allWordDecks'); if (savedDecks) { const parsed = JSON.parse(savedDecks); if (typeof parsed === 'object' && parsed !== null) { loadedDecks = parsed; } } } catch (e) { console.error("載入單字包列表失敗，將重置。", e); loadedDecks = {}; } if (!loadedDecks.hasOwnProperty(DEFAULT_DECK_NAME)) { loadedDecks[DEFAULT_DECK_NAME] = []; } allWordCategoriesData = loadedDecks; allOriginalWordsFlat = Object.values(allWordCategoriesData).flat(); saveAppState(); }
        function saveProgress() { try { localStorage.setItem('unfamiliarWordsList', JSON.stringify(unfamiliarWordsInNormalCycle)); } catch (e) { console.error("無法保存不熟單字列表。", e); } }
        function loadUnfamiliarWords() { try { const s = localStorage.getItem('unfamiliarWordsList'); unfamiliarWordsInNormalCycle = s ? JSON.parse(s) : []; } catch (e) { console.error("載入不熟單字列表失敗。", e); unfamiliarWordsInNormalCycle = []; } }
        function saveStudyMode() { try { localStorage.setItem('studyMode', currentStudyMode); } catch (e) { console.error("無法保存學習模式。", e); } }
        function loadStudyMode() { try { const savedMode = localStorage.getItem('studyMode'); if (savedMode === 'zh-first') { currentStudyMode = 'zh-first'; modeToggle.checked = true; } else { currentStudyMode = 'en-first'; modeToggle.checked = false; } } catch (e) { console.error("載入學習模式失敗。", e); currentStudyMode = 'en-first'; } }

        function showView(viewName) { for (let id in views) { views[id].classList.remove('active'); } views[viewName].classList.add('active'); const showTopButtons = (viewName === 'flashcard-view' || viewName === 'deck-management-view'); backToMenuBtnTop.style.display = showTopButtons ? 'flex' : 'none'; fullscreenBtn.style.display = showTopButtons ? 'flex' : 'none'; if (viewName === 'main-menu-view') renderMainMenu(); }
        function renderMainMenu() { mainMenuContainer.innerHTML = ''; const createCategoryButton = (categoryName, specialClass = '') => { const item = document.createElement('div'); item.className = `category-item ${specialClass}`; item.innerHTML = `<span>${categoryName}</span><span class="manage-deck-btn" title="管理 '${categoryName}'">⚙️</span>`; item.querySelector('.manage-deck-btn').addEventListener('click', e => { e.stopPropagation(); openDeckManager(categoryName); }); item.addEventListener('click', () => startCategoryLearning(categoryName)); mainMenuContainer.appendChild(item); }; const customDeckNames = Object.keys(allWordCategoriesData).filter(name => name !== DEFAULT_DECK_NAME); customDeckNames.forEach(name => createCategoryButton(name)); if (allWordCategoriesData.hasOwnProperty(DEFAULT_DECK_NAME)) { createCategoryButton(DEFAULT_DECK_NAME, 'default-category'); } const unfamiliarItem = document.createElement('div'); unfamiliarItem.className = 'category-item unfamiliar-category'; unfamiliarItem.innerHTML = `<span>不熟單字</span> <span class="unfamiliar-count">${unfamiliarWordsInNormalCycle.length}</span>`; unfamiliarItem.addEventListener('click', startUnfamiliarReviewMode); mainMenuContainer.appendChild(unfamiliarItem); }
        function openAddWordModal() { addWordModal.classList.add('active'); setTimeout(() => newWordEnglishInput.focus(), 50); }
        function closeAddWordModal() { addWordForm.reset(); addWordFeedback.classList.remove('show'); clearTimeout(feedbackTimeout); addWordModal.classList.remove('active'); }

        function showConfirmModal(title, text, onConfirm) { confirmModalTitle.textContent = title; confirmModalText.innerHTML = text; confirmAction = onConfirm; confirmModal.classList.add('active'); }
        function closeConfirmModal() { confirmModal.classList.remove('active'); confirmAction = null; }

        function openDeckManager(categoryName) { currentManagingDeck = categoryName; deckManagerTitle.textContent = `管理: ${categoryName}`; if (categoryName === DEFAULT_DECK_NAME) { deleteDeckBtn.disabled = true; deleteDeckBtn.title = "預設單字包無法刪除"; } else { deleteDeckBtn.disabled = false; deleteDeckBtn.title = ""; } renderWordList(categoryName); showView('deck-management-view'); }
        
        function renderWordList(categoryName) {
            wordListContainer.innerHTML = '';
            selectedWordsToDelete.clear();
            currentlyEditingElement = null;

            const words = allWordCategoriesData[categoryName] || [];
            if (words.length === 0) {
                wordListContainer.innerHTML = '<p style="color: #888; padding: 20px 0; text-align: center;">這個單字包是空的。點擊右下角 + 來新增！</p>';
            } else {
                words.forEach(word => {
                    const item = document.createElement('div');
                    item.className = 'word-list-item';
                    item.dataset.originalEnglish = word.english;
                    
                    item.innerHTML = `
                        <input type="checkbox" class="word-select-checkbox" data-english="${word.english}">
                        <div class="word-content-wrapper">
                            <div class="word-display-container" title="點擊以編輯">
                                <span><strong>${word.english}</strong>: ${word.chinese}</span>
                            </div>
                            <div class="word-edit-container">
                                <input class="edit-english" value="${word.english}" placeholder="英文單字">
                                <input class="edit-chinese" value="${word.chinese}" placeholder="中文翻譯">
                                <button class="save-edit-btn" title="儲存">&#x2713;</button>
                                <button class="cancel-edit-btn" title="取消">&times;</button>
                            </div>
                        </div>
                    `;
                    wordListContainer.appendChild(item);
                });
            }
            updateMultiDeleteUI();
            selectAllCheckbox.checked = false;
        }

        function enterEditMode(item) {
            if (currentlyEditingElement && currentlyEditingElement !== item) {
                exitEditMode(currentlyEditingElement, false);
            }
            currentlyEditingElement = item;
            item.classList.add('editing');
            item.querySelector('.edit-english').focus();
        }

        function exitEditMode(item, shouldSave) {
            if (!item) return;

            if (shouldSave) {
                const originalEng = item.dataset.originalEnglish;
                const newEngInput = item.querySelector('.edit-english');
                const newChiInput = item.querySelector('.edit-chinese');
                const newEng = newEngInput.value.trim();
                const newChi = newChiInput.value.trim();

                if (!newEng || !newChi) {
                    alert('英文和中文欄位都不能為空！');
                    return;
                }

                if (newEng.toLowerCase() !== originalEng.toLowerCase() && allWordCategoriesData[currentManagingDeck].some(w => w.english.toLowerCase() === newEng.toLowerCase())) {
                    alert(`單字 "${newEng}" 已存在於此單字包中！`);
                    return;
                }

                const wordIndex = allWordCategoriesData[currentManagingDeck].findIndex(w => w.english === originalEng);
                if (wordIndex > -1) {
                    allWordCategoriesData[currentManagingDeck][wordIndex] = { english: newEng, chinese: newChi };
                    saveAppState();

                    item.querySelector('.word-display-container span').innerHTML = `<strong>${newEng}</strong>: ${newChi}`;
                    item.dataset.originalEnglish = newEng;
                    item.querySelector('.word-select-checkbox').dataset.english = newEng;
                }
            } else {
                const originalEng = item.dataset.originalEnglish;
                const originalWord = allWordCategoriesData[currentManagingDeck].find(w => w.english === originalEng);
                if (originalWord) {
                     item.querySelector('.edit-english').value = originalWord.english;
                     item.querySelector('.edit-chinese').value = originalWord.chinese;
                }
            }
            
            item.classList.remove('editing');
            if (currentlyEditingElement === item) {
                currentlyEditingElement = null;
            }
        }

        function handleWordSelectionChange(event) {
            const checkbox = event.target;
            const wordEng = checkbox.dataset.english;
            if (checkbox.checked) {
                selectedWordsToDelete.add(wordEng);
            } else {
                selectedWordsToDelete.delete(wordEng);
            }
            const allWordCheckboxes = wordListContainer.querySelectorAll('.word-select-checkbox');
            selectAllCheckbox.checked = allWordCheckboxes.length > 0 && selectedWordsToDelete.size === allWordCheckboxes.length;
            updateMultiDeleteUI();
        }

        function updateMultiDeleteUI() {
            const count = selectedWordsToDelete.size;
            if (count > 0) {
                multiDeleteBtn.disabled = false;
                multiDeleteBtn.textContent = `刪除已選 (${count})`;
            } else {
                multiDeleteBtn.disabled = true;
                multiDeleteBtn.textContent = `刪除已選 (0)`;
            }
        }
        
        function handleDeleteDeck() {
            if (!currentManagingDeck || currentManagingDeck === DEFAULT_DECK_NAME) return;
            showConfirmModal(
                '確認刪除單字包',
                `您確定要永久刪除「<strong>${currentManagingDeck}</strong>」這個單字卡包嗎？<br>此操作無法復原！`,
                () => {
                    delete allWordCategoriesData[currentManagingDeck];
                    saveAppState();
                    alert(`單字卡包「${currentManagingDeck}」已刪除。`);
                    backToMainMenu();
                }
            );
        }

        function handleMultiDelete() {
            const count = selectedWordsToDelete.size;
            if (count === 0 || !currentManagingDeck) return;

            showConfirmModal(
                '確認刪除單字',
                `確定要從 "${currentManagingDeck}" 中永久刪除這 <strong>${count}</strong> 個單字嗎？`,
                () => {
                    allWordCategoriesData[currentManagingDeck] = allWordCategoriesData[currentManagingDeck].filter(
                        word => !selectedWordsToDelete.has(word.english)
                    );
                    saveAppState();
                    renderWordList(currentManagingDeck);
                }
            );
        }

        function handleAddWord(event) { event.preventDefault(); const newEng = newWordEnglishInput.value.trim(); const newChi = newWordChineseInput.value.trim(); if (!newEng || !newChi || !currentManagingDeck) return alert('英文和中文欄位都不能為空！'); if (allWordCategoriesData[currentManagingDeck].some(w => w.english.toLowerCase() === newEng.toLowerCase())) return alert(`單字 "${newEng}" 已存在！`); allWordCategoriesData[currentManagingDeck].push({ english: newEng, chinese: newChi }); saveAppState(); renderWordList(currentManagingDeck); addWordFeedback.textContent = '新增成功！'; addWordFeedback.classList.add('show'); clearTimeout(feedbackTimeout); feedbackTimeout = setTimeout(() => { addWordFeedback.classList.remove('show'); }, 2000); addWordForm.reset(); newWordEnglishInput.focus(); }
        function handleExportDeck() { if (!currentManagingDeck) return; const deckName = currentManagingDeck; const wordsToExport = allWordCategoriesData[deckName] || []; if (wordsToExport.length === 0) { alert(`「${deckName}」是空的，沒有可匯出的單字。`); return; } const jsonString = JSON.stringify(wordsToExport, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${deckName}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        function handleFileImport() { if (fileImporter.files.length === 0) return alert('請先選擇一個或多個 .json 檔案！'); for (const file of fileImporter.files) { const reader = new FileReader(); reader.onload = (event) => { try { const newWords = JSON.parse(event.target.result); if (!Array.isArray(newWords) || (newWords.length > 0 && (!newWords[0].english || !newWords[0].chinese))) throw new Error(`檔案 "${file.name}" 格式不正確。`); const categoryName = file.name.replace(/\.json$/i, ''); if (categoryName === DEFAULT_DECK_NAME) { if (!confirm(`您正試圖用檔案 "${file.name}" 覆蓋預設單字包 "${DEFAULT_DECK_NAME}"。\n確定要繼續嗎？`)) return; } else if (allWordCategoriesData[categoryName] && !confirm(`分類 "${categoryName}" 已存在。是否要用檔案 "${file.name}" 的內容覆蓋它？`)) return; allWordCategoriesData[categoryName] = newWords; saveAppState(); renderMainMenu(); alert(`分類 "${categoryName}" 已成功從檔案 "${file.name}" 匯入/更新！`); } catch (e) { alert(`匯入檔案 "${file.name}" 失敗: ` + e.message); } }; reader.onerror = () => alert(`讀取檔案 "${file.name}" 時發生錯誤。`); reader.readAsText(file); } fileImporter.value = ''; }
        
        function filterAndPrepareWords(wordList) { if (!wordList) return []; const flatList = Object.values(allWordCategoriesData).flat(); return wordList.filter(w => flatList.some(ow => ow.english === w.english && ow.chinese === w.chinese)).map(w => ({...w, revealed: w.revealed || false})); };
        function startCategoryLearning(categoryName) { currentCategoryName = categoryName; currentWordsSource = allWordCategoriesData[categoryName]; if (!currentWordsSource || currentWordsSource.length === 0) { alert(`"${categoryName}" 類別目前沒有單字！\n請點擊右方的 ⚙️ 圖示來新增單字。`); return; } currentMode = 'normal'; shuffledWords = shuffleArray(currentWordsSource.map(w => ({ ...w, revealed: false }))); currentIndex = 0; displayCard(); showView('flashcard-view'); }
        function startUnfamiliarReviewMode() { const validUnfamiliarWords = filterAndPrepareWords(unfamiliarWordsInNormalCycle); if (validUnfamiliarWords.length !== unfamiliarWordsInNormalCycle.length) { unfamiliarWordsInNormalCycle = validUnfamiliarWords; saveProgress(); } if (unfamiliarWordsInNormalCycle.length === 0) { alert('目前沒有不熟的單字可以複習！'); return; } currentCategoryName = '不熟單字'; currentMode = 'review'; shuffledWords = shuffleArray(unfamiliarWordsInNormalCycle.map(w => ({ ...w, revealed: false }))); currentIndex = 0; displayCard(); showView('flashcard-view'); }
        
        function handleSpeakWord(event) {
            event.stopPropagation();
            if (shuffledWords.length === 0) return;
            const wordToSpeak = shuffledWords[currentIndex].english;
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(wordToSpeak);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                alert('您的瀏覽器不支援語音合成功能。');
            }
        }

        function displayCard() {
            if (shuffledWords.length === 0) {
                wordDisplay.textContent = "此類別沒有單字。"; 
                translationDisplay.textContent = ""; 
                translationDisplay.style.display = 'none'; 
                currentCountSpan.textContent = 0; 
                totalCountSpan.textContent = 0; 
                markUnfamiliarBtn.style.display = 'none'; 
                modeDisplay.textContent = "完成！"; 
                flashcard.classList.remove('revealed-background'); 
                bookmarkIcon.style.display = 'none';
                speakBtn.style.display = 'none';
                return; 
            }
            speakBtn.style.display = 'block';
            const currentWord = shuffledWords[currentIndex];
            let frontText, backText;
            if (currentStudyMode === 'zh-first') { frontText = currentWord.chinese; backText = currentWord.english; } else { frontText = currentWord.english; backText = currentWord.chinese; }
            wordDisplay.textContent = frontText;
            translationDisplay.textContent = backText;
            if (currentWord.revealed) { translationDisplay.style.display = 'block'; flashcard.classList.add('revealed-background'); } else { translationDisplay.style.display = 'none'; flashcard.classList.remove('revealed-background'); }
            const isBookmarked = unfamiliarWordsInNormalCycle.some(w => w.english === currentWord.english);
            bookmarkIcon.style.display = isBookmarked ? 'block' : 'none';
            updateProgress();
            markUnfamiliarBtn.style.display = 'block';
            updateButtonText();
            modeDisplay.textContent = currentMode === 'normal' ? `學習模式: ${currentCategoryName}` : '複習模式: 不熟單字';
        }
        
        function handleCardClick(event) {
            if (shuffledWords.length === 0) return;
            const cardWidth = flashcard.offsetWidth;
            const clickX = event.clientX - flashcard.getBoundingClientRect().left;
            const currentWordObj = shuffledWords[currentIndex];
            if (clickX < cardWidth / 2) { showPreviousWord(); } else { if (!currentWordObj.revealed) { translationDisplay.style.display = 'block'; flashcard.classList.add('revealed-background'); currentWordObj.revealed = true; } else { showNextWord(); } }
        }

        function showPreviousWord() { if (shuffledWords.length > 0 && currentIndex > 0) { currentIndex--; displayCard(); } }
        function showNextWord() { if (shuffledWords.length > 0) { currentIndex++; if (currentIndex >= shuffledWords.length) handleCycleEnd(); else displayCard(); } }
        function handleCycleEnd() { if (currentMode === 'normal') { if (unfamiliarWordsInNormalCycle.length > 0 && confirm(`"${currentCategoryName}"單字已看過一次！是否要跳到複習不熟的單字？`)) { startUnfamiliarReviewMode(); } else { alert(`"${currentCategoryName}"單字已看過一次！即將重新開始。`); startCategoryLearning(currentCategoryName); } } else { if (confirm('不熟單字已複習完畢！是否要再次複習這些單字？')) { startUnfamiliarReviewMode(); } else { alert('即將返回主菜單。'); showView('main-menu-view'); } } }
        function handleUnfamiliarAction() { if (shuffledWords.length === 0) return; const currentWord = shuffledWords[currentIndex]; const isBookmarked = unfamiliarWordsInNormalCycle.some(word => word.english === currentWord.english); if (currentMode === 'normal') { if (!isBookmarked) { unfamiliarWordsInNormalCycle.push({ ...currentWord, revealed: false }); } else { unfamiliarWordsInNormalCycle = unfamiliarWordsInNormalCycle.filter(word => word.english !== currentWord.english); } } else { unfamiliarWordsInNormalCycle = unfamiliarWordsInNormalCycle.filter(word => word.english !== currentWord.english); shuffledWords.splice(currentIndex, 1); if (shuffledWords.length === 0) { currentIndex = 0; handleCycleEnd(); return; } else if (currentIndex >= shuffledWords.length) { currentIndex = shuffledWords.length - 1; } } saveProgress(); renderMainMenu(); displayCard(); }
        function updateButtonText() { if (shuffledWords.length === 0) return; const isBookmarked = unfamiliarWordsInNormalCycle.some(w => w.english === shuffledWords[currentIndex].english); if (currentMode === 'normal') { markUnfamiliarBtn.classList.remove('delete-mode'); markUnfamiliarBtn.textContent = isBookmarked ? '取消標記不熟' : '標記為不熟'; markUnfamiliarBtn.classList.toggle('unmark-mode', isBookmarked); } else { markUnfamiliarBtn.textContent = '刪除不熟'; markUnfamiliarBtn.classList.add('delete-mode'); markUnfamiliarBtn.classList.remove('unmark-mode'); } }
        function updateProgress() { currentCountSpan.textContent = shuffledWords.length > 0 ? currentIndex + 1 : 0; totalCountSpan.textContent = shuffledWords.length; }
        function backToMainMenu() { if(currentlyEditingElement) { exitEditMode(currentlyEditingElement, false); } currentManagingDeck = null; showView('main-menu-view'); }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => alert(`無法進入全螢幕模式: ${err.message}`)); else document.exitFullscreen(); }
        
        function init() {
            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }

            loadAppState(); 
            loadUnfamiliarWords();
            loadStudyMode();
            showView('main-menu-view');
            
            backToMenuBtnTop.addEventListener('click', backToMainMenu);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            importBtn.addEventListener('click', handleFileImport);
            deleteDeckBtn.addEventListener('click', handleDeleteDeck);
            exportDeckBtn.addEventListener('click', handleExportDeck);
            flashcard.addEventListener('click', handleCardClick);
            speakBtn.addEventListener('click', handleSpeakWord);
            markUnfamiliarBtn.addEventListener('click', handleUnfamiliarAction);
            openAddWordModalBtn.addEventListener('click', openAddWordModal);
            addWordForm.addEventListener('submit', handleAddWord);
            addWordModal.querySelector('.modal-close-btn').addEventListener('click', closeAddWordModal);
            addWordModal.addEventListener('click', (event) => { if (event.target === addWordModal) { closeAddWordModal(); } });
            modeToggle.addEventListener('change', () => { currentStudyMode = modeToggle.checked ? 'zh-first' : 'en-first'; saveStudyMode(); });

            confirmModalConfirmBtn.addEventListener('click', () => { if (typeof confirmAction === 'function') { confirmAction(); } closeConfirmModal(); });
            confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
            confirmModal.querySelector('.modal-close-btn').addEventListener('click', closeConfirmModal);
            confirmModal.addEventListener('click', (event) => { if (event.target === confirmModal) { closeConfirmModal(); } });
            
            multiDeleteBtn.addEventListener('click', handleMultiDelete);
            selectAllCheckbox.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                wordListContainer.querySelectorAll('.word-select-checkbox').forEach(checkbox => {
                    if (checkbox.checked !== isChecked) {
                        checkbox.checked = isChecked;
                        const changeEvent = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(changeEvent);
                    }
                });
            });

            wordListContainer.addEventListener('click', (e) => {
                const item = e.target.closest('.word-list-item');
                if (!item) return;

                if (e.target.closest('.word-display-container')) {
                    enterEditMode(item);
                } else if (e.target.classList.contains('save-edit-btn')) {
                    exitEditMode(item, true);
                } else if (e.target.classList.contains('cancel-edit-btn')) {
                    exitEditMode(item, false);
                }
            });

            wordListContainer.addEventListener('change', (e) => {
                 if (e.target.classList.contains('word-select-checkbox')) {
                    handleWordSelectionChange(e);
                }
            });
            
            wordListContainer.addEventListener('keydown', (e) => {
                if (e.key !== 'Enter' && e.key !== 'Escape') return;
                if (currentlyEditingElement && currentlyEditingElement.contains(e.target)) {
                    e.preventDefault();
                    if (e.key === 'Enter') exitEditMode(currentlyEditingElement, true);
                    if (e.key === 'Escape') exitEditMode(currentlyEditingElement, false);
                }
            });

            setInterval(saveProgress, 10000); 
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>